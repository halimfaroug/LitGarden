<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ENGL280: An Introduction to Literature ‚Äî Interactive Study Platform</title>

  <!--
    Changes vs previous:
    - Brighter, nature-themed palette (fresh greens/sky)
    - Much brighter background (daylight)
    - Bigger font across UI
    - Better-looking font stack (Poppins-like; offline-safe)
    - Background music: offline WebAudio ‚Äúnature ambience‚Äù (birds + wind + soft pad)
      NOTE: Browsers require a user click to start audio.
  -->

  <style>
    :root{
      /* Bright nature theme */
      --bgTop:#eafcff;
      --bgMid:#e9fff1;
      --bgBot:#f7fff9;

      --panel: rgba(255,255,255,.72);
      --panel2: rgba(255,255,255,.58);
      --stroke: rgba(12,40,24,.14);

      --text: rgba(8,20,12,.92);
      --muted: rgba(8,20,12,.62);

      --accent:#00a3ff;     /* sky */
      --accent2:#22c55e;    /* leaf green */
      --accent3:#ffd166;    /* warm sunlight */

      --danger:#ff4d4d;
      --ok:#16a34a;

      --radius: 20px;
      --shadow: 0 18px 60px rgba(6, 28, 14, .14);
      --shadow2: 0 10px 30px rgba(6, 28, 14, .12);

      /* Bigger font */
      --base: 24px;
      --h1: 44px;
      --h2: 30px;
      --h3: 24px;
      --small: 17px;

      /* Better-looking offline-safe font stack (Poppins-like) */
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue",
              Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      font-size: var(--base);
      color: var(--text);
      overflow:hidden;
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(0,163,255,.18), transparent 55%),
        radial-gradient(1000px 700px at 85% 15%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(900px 600px at 65% 90%, rgba(255,209,102,.12), transparent 55%),
        linear-gradient(180deg, var(--bgTop), var(--bgMid), var(--bgBot));
    }

    /* Background canvas */
    #bgCanvas{
      position:fixed;
      inset:0;
      z-index:-2;
    }

    /* Brighter vignette (daylight haze) */
    .vignette{
      position:fixed;
      inset:0;
      z-index:-1;
      pointer-events:none;
      background:
        radial-gradient(900px 700px at 50% -10%, rgba(255,255,255,.92), transparent 60%),
        radial-gradient(900px 700px at 10% 60%, rgba(0,163,255,.12), transparent 60%),
        radial-gradient(900px 700px at 90% 70%, rgba(34,197,94,.12), transparent 60%),
        radial-gradient(900px 700px at 70% 95%, rgba(255,209,102,.10), transparent 60%);
      opacity:1;
    }

    .app{
      height:100%;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:0;
    }

    /* Sidebar */
    .sidebar{
      padding: 22px;
      border-right: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,.55));
      backdrop-filter: blur(10px);
      overflow:auto;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom: 14px;
    }
    .logo{
      width:52px;height:52px;
      border-radius: 16px;
      background: radial-gradient(circle at 30% 25%, rgba(0,163,255,.85), rgba(34,197,94,.55) 55%, rgba(255,209,102,.35));
      box-shadow: var(--shadow2);
      position:relative;
      overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute; inset:-45%;
      background: conic-gradient(from 180deg, rgba(255,255,255,0), rgba(255,255,255,.55), rgba(255,255,255,0));
      animation: spin 6s linear infinite;
    }
    @keyframes spin{ to{ transform:rotate(360deg);} }

    .brand h1{
      font-size: 24px;
      margin:0;
      letter-spacing:.3px;
      line-height:1.1;
    }
    .brand .sub{
      font-size: var(--small);
      color: var(--muted);
      margin-top:4px;
    }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin: 12px 0 16px;
    }
    .pill{
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: var(--panel2);
      box-shadow: 0 10px 24px rgba(6,28,14,.08);
      font-size: 16px;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, background .2s ease, border-color .2s ease;
    }
    .pill:hover{ transform: translateY(-1px); }
    .pill:active{ transform: translateY(0px) scale(.99); }

    .searchBox{
      position:sticky;
      top:0;
      padding-top: 6px;
      z-index:5;
    }
    .search{
      display:flex;
      gap:10px;
      align-items:center;
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.75);
      box-shadow: var(--shadow2);
    }
    .search input{
      flex:1;
      border:0;
      outline:none;
      background:transparent;
      color: var(--text);
      font-size: 18px;
    }
    .kbd{
      font-size: 12px;
      color: var(--muted);
      border:1px solid var(--stroke);
      padding: 4px 8px;
      border-radius: 10px;
      white-space:nowrap;
      background: rgba(255,255,255,.55);
    }

    .nav{
      margin-top: 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .nav button{
      width:100%;
      text-align:left;
      padding: 15px 14px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.68);
      color: var(--text);
      font-size: 18px;
      cursor:pointer;
      transition: transform .12s ease, background .2s ease, border-color .2s ease;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      box-shadow: 0 10px 24px rgba(6,28,14,.07);
    }
    .nav button:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.82);
      border-color: rgba(0,163,255,.35);
    }
    .nav button.active{
      border-color: rgba(34,197,94,.45);
      background: linear-gradient(90deg, rgba(34,197,94,.18), rgba(0,163,255,.12));
    }
    .nav small{
      color: var(--muted);
      font-size: 14px;
    }

    .progressCard{
      margin-top: 16px;
      padding: 14px 14px;
      border-radius: var(--radius);
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.70);
      box-shadow: var(--shadow2);
    }
    .progressCard h3{
      margin:0 0 10px;
      font-size: 19px;
    }
    .bar{
      height: 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.05);
      overflow:hidden;
      border:1px solid rgba(0,0,0,.07);
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(0,163,255,.92), rgba(34,197,94,.82), rgba(255,209,102,.72));
      border-radius: 999px;
      transition: width .35s ease;
    }
    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
      font-size: 15px;
      color: var(--muted);
    }
    .stats b{ color: var(--text); font-weight: 800; }

    /* Main content */
    .content{
      padding: 26px;
      overflow:auto;
      position:relative;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 18px;
      flex-wrap:wrap;
    }
    .titleBlock h2{
      margin:0;
      font-size: var(--h1);
      letter-spacing:.2px;
      line-height:1.05;
    }
    .titleBlock p{
      margin:10px 0 0;
      color: var(--muted);
      font-size: 20px;
      max-width: 980px;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      padding: 12px 14px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.72);
      color: var(--text);
      font-size: 16px;
      cursor:pointer;
      transition: transform .12s ease, background .2s ease, border-color .2s ease;
      user-select:none;
      box-shadow: 0 10px 24px rgba(6,28,14,.07);
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.86); }
    .btn:active{ transform: translateY(0px) scale(.99); }

    .btn.primary{
      border-color: rgba(0,163,255,.35);
      background: linear-gradient(90deg, rgba(0,163,255,.18), rgba(34,197,94,.12));
    }
    .btn.danger{
      border-color: rgba(255,77,77,.45);
      background: rgba(255,77,77,.12);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 16px;
      align-items:start;
    }

    .card{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.70);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding: 16px 18px;
      border-bottom: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.82), rgba(255,255,255,.62));
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .cardHeader h3{
      margin:0;
      font-size: var(--h2);
    }
    .cardBody{
      padding: 18px;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .chip{
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.68);
      font-size: 16px;
      cursor:pointer;
      transition: transform .12s ease, background .2s ease, border-color .2s ease;
      user-select:none;
      box-shadow: 0 8px 18px rgba(6,28,14,.06);
    }
    .chip:hover{ transform: translateY(-1px); background: rgba(255,255,255,.84); border-color: rgba(0,163,255,.28);}
    .chip.active{ border-color: rgba(34,197,94,.45); background: rgba(34,197,94,.12); }

    .note{
      padding: 14px 14px;
      border-radius: 16px;
      border:1px dashed rgba(34,197,94,.35);
      background: rgba(34,197,94,.08);
      color: rgba(8,20,12,.78);
      font-size: 17px;
      line-height:1.55;
      margin-top: 14px;
    }

    /* Lesson text */
    .cardBody p{ font-size: 22px; line-height:1.6; }
    .cardBody li{ font-size: 21px; line-height:1.55; margin: 8px 0; }

    /* Flashcards */
    .deckTop{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 12px;
    }
    .deckTop .left{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .select{
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.78);
      color: var(--text);
      font-size: 16px;
      outline:none;
      box-shadow: 0 8px 18px rgba(6,28,14,.06);
    }

    .flashWrap{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }
    .flashCard{
      min-height: 290px;
      border-radius: 20px;
      border: 1px solid var(--stroke);
      background:
        radial-gradient(900px 340px at 20% 10%, rgba(0,163,255,.18), transparent 60%),
        radial-gradient(900px 340px at 80% 20%, rgba(34,197,94,.16), transparent 55%),
        radial-gradient(900px 340px at 60% 95%, rgba(255,209,102,.12), transparent 55%),
        rgba(255,255,255,.72);
      box-shadow: var(--shadow);
      padding: 18px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      cursor:pointer;
      user-select:none;
      transition: transform .25s ease, border-color .25s ease;
      position:relative;
      overflow:hidden;
    }
    .flashCard:hover{ transform: translateY(-2px); border-color: rgba(0,163,255,.35); }
    .flashCard:active{ transform: translateY(0px) scale(.995); }

    .flashFace{
      font-size: 38px;
      line-height:1.15;
      letter-spacing:.2px;
      font-weight: 800;
    }
    .flashBack{
      font-size: 24px;
      line-height:1.6;
      color: rgba(8,20,12,.74);
      margin-top: 14px;
      display:none;
      font-weight: 500;
    }
    .flashCard.revealed .flashBack{ display:block; }
    .flashMeta{
      margin-top: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: var(--muted);
      font-size: 15px;
      flex-wrap:wrap;
    }
    .tag{
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.70);
      color: var(--muted);
      font-size: 14px;
      box-shadow: 0 8px 18px rgba(6,28,14,.05);
    }
    .level{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .lvlBtn{
      padding: 9px 12px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.78);
      color: var(--text);
      font-size: 14px;
      cursor:pointer;
      box-shadow: 0 8px 18px rgba(6,28,14,.05);
    }
    .lvlBtn.active{
      border-color: rgba(34,197,94,.50);
      background: rgba(34,197,94,.14);
    }

    /* Quiz */
    .qBox{
      padding: 16px;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.74);
      margin-bottom: 14px;
      box-shadow: 0 10px 24px rgba(6,28,14,.08);
    }
    .qTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
      flex-wrap:wrap;
    }
    .qTop h4{
      margin:0;
      font-size: 24px;
      line-height:1.35;
      font-weight: 800;
    }
    .qMeta{
      color: var(--muted);
      font-size: 14px;
      white-space:nowrap;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.68);
      height: fit-content;
      box-shadow: 0 8px 18px rgba(6,28,14,.05);
    }
    .opt{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.70);
      cursor:pointer;
      margin-top: 10px;
      transition: transform .12s ease, background .2s ease, border-color .2s ease;
      box-shadow: 0 8px 18px rgba(6,28,14,.05);
    }
    .opt:hover{ transform: translateY(-1px); background: rgba(255,255,255,.86); border-color: rgba(0,163,255,.28); }
    .opt input{ margin-top: 4px; transform: scale(1.25); }
    .feedback{
      margin-top: 12px;
      font-size: 17px;
      line-height:1.55;
      color: rgba(8,20,12,.76);
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.64);
    }
    .feedback.good{ border-color: rgba(22,163,74,.35); background: rgba(22,163,74,.10); }
    .feedback.bad{ border-color: rgba(255,77,77,.35); background: rgba(255,77,77,.10); }

    /* Mind maps */
    .mapList{ display:grid; gap:12px; }
    details.map{
      border:1px solid var(--stroke);
      border-radius: 18px;
      background: rgba(255,255,255,.74);
      overflow:hidden;
      box-shadow: 0 10px 24px rgba(6,28,14,.07);
    }
    details.map > summary{
      padding: 14px 14px;
      cursor:pointer;
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      user-select:none;
      font-size: 19px;
      font-weight: 750;
    }
    details.map > summary::-webkit-details-marker{ display:none; }
    .mapBody{
      padding: 0 14px 14px;
      color: rgba(8,20,12,.74);
      font-size: 17px;
      line-height:1.6;
    }
    .tree{ margin: 10px 0 0; padding-left: 18px; }
    .tree li{ margin: 8px 0; }

    .jump{
      color: rgba(0,163,255,.95);
      text-decoration:none;
      border-bottom: 1px dashed rgba(0,163,255,.55);
    }

    .footer{
      margin-top: 16px;
      padding: 12px 14px;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.72);
      color: var(--muted);
      font-size: 15px;
      box-shadow: 0 10px 24px rgba(6,28,14,.06);
    }

    /* Modal */
    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index:50;
    }
    .modal{
      width:min(980px, 100%);
      max-height: 86vh;
      overflow:auto;
      border-radius: 20px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.92);
      box-shadow: var(--shadow);
    }
    .modalHead{
      padding: 14px 16px;
      border-bottom: 1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.80));
    }
    .modalHead h3{ margin:0; font-size: 20px;}
    .modalBody{ padding: 16px; }

    /* Responsive */
    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{
        position:sticky; top:0;
        border-right:0; border-bottom:1px solid var(--stroke);
      }
      body{ overflow:auto; }
      .content{ overflow:visible; }
      .grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <canvas id="bgCanvas" aria-hidden="true"></canvas>
  <div class="vignette" aria-hidden="true"></div>

  <div class="app" id="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>ENGL280</h1>
          <div class="sub">Bright Nature Theme ‚Ä¢ Big Font ‚Ä¢ Interactive</div>
        </div>
      </div>

      <div class="pillRow">
        <div class="pill" id="focusBtn" title="Hide sidebar for focus">Focus</div>
        <div class="pill" id="musicBtn" title="Start/Stop music (click required)">Music</div>
        <div class="pill" id="resetBtn" title="Reset progress">Reset</div>
      </div>

      <div class="searchBox">
        <div class="search">
          <span aria-hidden="true">üîé</span>
          <input id="searchInput" type="text" placeholder="Search terms, topics, quizzes‚Ä¶" />
          <span class="kbd">Ctrl /</span>
        </div>
      </div>

      <div class="nav" id="nav"></div>

      <div class="progressCard">
        <h3>Progress</h3>
        <div class="bar" aria-label="overall progress">
          <div id="progressFill"></div>
        </div>
        <div class="stats">
          <div><b id="statCards">0</b> / 50 cards mastered</div>
          <div><b id="statQuizzes">0</b> / 50 quizzes correct</div>
          <div><b id="statMaps">0</b> / 25 maps visited</div>
          <div><b id="statStreak">0</b> day streak</div>
        </div>
      </div>

      <div class="footer">
        Developer: <b>Halim Faroug A. Elhag, Lecturer, UHB / UofK</b><br/>
        Tip: Press <b>Ctrl + /</b> to jump to search. Press <b>G</b> then <b>1‚Äì9</b> to open modules.
      </div>
    </aside>

    <!-- MAIN -->
    <main class="content">
      <div class="topbar">
        <div class="titleBlock">
          <h2 id="pageTitle">Home</h2>
          <p id="pageSubtitle">Brighter design + larger font + natural background + music ambience.</p>
        </div>

        <div class="actions">
          <button class="btn" id="bookmarkBtn" title="Bookmark this module">Bookmark</button>
          <button class="btn primary" id="quickPracticeBtn" title="Start a quick mixed practice set">Quick Practice</button>
          <button class="btn" id="openDashboardBtn" title="Open a learning dashboard">Dashboard</button>
          <button class="btn primary" id="startMusicTopBtn" title="Start music">Start Music</button>
        </div>
      </div>

      <div class="grid">
        <section class="card" id="learnCard">
          <div class="cardHeader">
            <h3>Learn</h3>
            <div class="chips" id="modeChips">
              <div class="chip active" data-mode="learn">Lesson</div>
              <div class="chip" data-mode="flashcards">Flashcards</div>
              <div class="chip" data-mode="quiz">Quiz</div>
              <div class="chip" data-mode="mindmap">Mind Map</div>
            </div>
          </div>
          <div class="cardBody" id="learnBody"></div>
        </section>

        <aside class="card" id="toolsCard">
          <div class="cardHeader">
            <h3>Practice</h3>
            <button class="btn" id="nextBtn" title="Next module">Next</button>
          </div>
          <div class="cardBody" id="toolsBody"></div>
        </aside>
      </div>
    </main>
  </div>

  <!-- MODAL -->
  <div class="modalBackdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <h3 id="modalTitle">Dashboard</h3>
        <button class="btn" id="closeModalBtn">Close</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <script>
    /**********************
     * DATA (Modules) ‚Äî same content as previous
     **********************/
    const modules = [
      {
        id: "home",
        title: "Home",
        subtitle: "Bright, natural theme. Big font. Offline-friendly. Music ambience (click to start).",
        learn: `
          <div class="note">
            <b>What‚Äôs new:</b><br/>
            ‚Ä¢ Brighter nature theme (daylight greens + sky)<br/>
            ‚Ä¢ Larger font everywhere<br/>
            ‚Ä¢ Better-looking UI font stack (offline-safe)<br/>
            ‚Ä¢ Background music ambience (generated, no external files)
          </div>

          <p><b>Use it:</b></p>
          <ul>
            <li>Pick a module on the left.</li>
            <li>Switch mode: <b>Lesson / Flashcards / Quiz / Mind Map</b>.</li>
            <li>Click <b>Music</b> to start ambience (browser requires a click).</li>
          </ul>

          <p><b>Developer:</b> Halim Faroug A. Elhag, Lecturer, UHB / UofK</p>
        `
      },
      {
        id: "m1",
        title: "Module 1: Introduction to Literature & Its Genres",
        subtitle: "What literature is, what it does, why it matters, and how genres organize experience.",
        learn: `
          <p><b>Core questions</b></p>
          <ul>
            <li><b>What is literature?</b> Language shaped for meaning, experience, and effect.</li>
            <li><b>What does it do?</b> It entertains, persuades, preserves culture, questions power, and enlarges empathy.</li>
            <li><b>Genres</b> are categories (poetry, drama, fiction, etc.) with typical conventions.</li>
            <li><b>Why study literature?</b> Stronger critical reading, interpretive skill, and argument writing.</li>
          </ul>

          <p><b>Fast genre map</b></p>
          <ul>
            <li><b>Poetry:</b> patterned language (sound, rhythm, imagery) + compressed meaning.</li>
            <li><b>Drama:</b> written for performance (dialogue, stage directions, spectacle).</li>
            <li><b>Fiction:</b> invented narrative (character, plot, setting, theme).</li>
          </ul>
        `
      },
      {
        id: "m2",
        title: "Module 2: Basic Literary Terms",
        subtitle: "Key vocabulary for reading and analysis: literal vs figurative, tone, theme, etc.",
        learn: `
          <p><b>Essential terms</b></p>
          <ul>
            <li><b>Figure of speech:</b> non-literal use for effect (rhetorical/vivid).</li>
            <li><b>Denotation / Connotation:</b> dictionary meaning vs associated meaning.</li>
            <li><b>Tone:</b> speaker‚Äôs attitude (ironic, joyful, bitter‚Ä¶).</li>
            <li><b>Theme:</b> central idea/claim about life, society, or human nature.</li>
            <li><b>Motif:</b> recurring element supporting theme.</li>
          </ul>

          <p><b>Comparison tools</b></p>
          <ul>
            <li><b>Simile:</b> ‚Äúlike/as‚Äù comparison.</li>
            <li><b>Metaphor:</b> direct comparison.</li>
            <li><b>Analogy:</b> extended comparison explaining a concept.</li>
          </ul>

          <p><b>Immersion tools</b></p>
          <ul>
            <li><b>Imagery:</b> sensory detail.</li>
            <li><b>Personification:</b> human traits to non-human.</li>
            <li><b>Onomatopoeia:</b> word echoes sound.</li>
          </ul>
        `
      },
      {
        id: "m3",
        title: "Module 3: Figures of Speech and Sound Devices",
        subtitle: "Meaning + music: how language works on the mind and the ear.",
        learn: `
          <p><b>Figures of speech</b></p>
          <ul>
            <li>Metaphor, simile, symbol, hyperbole, understatement, irony, allusion.</li>
            <li>They compress ideas and intensify effect.</li>
          </ul>

          <p><b>Sound devices</b></p>
          <ul>
            <li><b>Alliteration:</b> repeated initial consonants.</li>
            <li><b>Assonance:</b> repeated vowel sounds.</li>
            <li><b>Consonance:</b> repeated consonant sounds.</li>
            <li><b>Rhyme / rhythm / meter:</b> patterning that shapes pace and mood.</li>
          </ul>

          <div class="note">
            Devices are not decoration. They are <b>meaning machines</b>.
          </div>
        `
      },
      {
        id: "m4",
        title: "Module 4: Poetry and Major Aspects of a Poem",
        subtitle: "Poetry as patterned, intensified language: voice, imagery, sound, form, theme.",
        learn: `
          <p><b>Poetry: what typically defines it</b></p>
          <ul>
            <li>Patterned arrangement of language</li>
            <li>Rhythm (and sometimes meter)</li>
            <li>Concentration / intensity</li>
            <li>Emotion and idea fused</li>
          </ul>

          <p><b>Major elements</b></p>
          <ul>
            <li><b>Speaker/voice</b></li>
            <li><b>Diction & syntax</b></li>
            <li><b>Imagery</b></li>
            <li><b>Sound</b></li>
            <li><b>Form</b></li>
            <li><b>Theme</b></li>
          </ul>
        `
      },
      {
        id: "m5",
        title: "Module 5: Sample Poetry ‚Äî ‚ÄúWinter‚Äù (Shakespeare)",
        subtitle: "Close reading: seasonal imagery, sound, contrast, and social detail.",
        learn: `
          <p><b>Reading focus</b></p>
          <ul>
            <li><b>Imagery:</b> cold vs warmth; outdoor hardship vs indoor comfort.</li>
            <li><b>Sound:</b> repeated consonants/vowels can sharpen the ‚Äúbite‚Äù of winter.</li>
            <li><b>Contrast:</b> nature‚Äôs harshness vs human shelter/community.</li>
            <li><b>Theme:</b> how environment shapes daily life and mood.</li>
          </ul>

          <div class="note">
            Don‚Äôt summarize. Identify <b>patterns</b> ‚Üí infer <b>effect</b> ‚Üí argue <b>theme</b>.
          </div>
        `
      },
      {
        id: "m6",
        title: "Module 6: Drama and Major Aspects of a Play",
        subtitle: "Drama as performance text: dialogue, action, stage directions, structure.",
        learn: `
          <p><b>Drama is built for performance</b></p>
          <ul>
            <li><b>Dialogue</b> carries conflict and character.</li>
            <li><b>Stage directions</b> shape space, movement, and pacing.</li>
          </ul>

          <p><b>Classical structure (overview)</b></p>
          <ul>
            <li>Prologue ‚Üí Episodes ‚Üí Stasimon ‚Üí Exodos.</li>
          </ul>
        `
      },
      {
        id: "m7",
        title: "Module 7: Sample Play ‚Äî Trifles (Susan Glaspell)",
        subtitle: "Inference and evidence: how details reveal power, gender, and justice.",
        learn: `
          <p><b>Why it matters</b></p>
          <ul>
            <li>Meaning comes from <b>small details</b> and what they imply.</li>
            <li>Competing interpretations of evidence: official vs overlooked.</li>
            <li>Theme cluster: gendered labor, empathy, justice, authority.</li>
          </ul>

          <div class="note">
            What counts as ‚Äúevidence‚Äù is often a <b>power decision</b>.
          </div>
        `
      },
      {
        id: "m8",
        title: "Module 8: Fiction and Major Aspects of Fiction",
        subtitle: "Narrative craft: plot, character, setting, POV, theme, and genre by length.",
        learn: `
          <p><b>Fiction: definition</b></p>
          <ul>
            <li>Invented narrative arranged for meaning and effect.</li>
          </ul>

          <p><b>By length</b></p>
          <ul>
            <li><b>Novel:</b> usually 40,000+ words.</li>
            <li><b>Novella:</b> ~10,000‚Äì40,000 words.</li>
            <li><b>Short story:</b> ~1,000‚Äì10,000 words.</li>
          </ul>

          <p><b>Major elements</b></p>
          <ul>
            <li>Plot, character, setting, point of view, theme.</li>
          </ul>
        `
      },
      {
        id: "m9",
        title: "Module 9: Sample Novel ‚Äî Pride & Prejudice (Jane Austen)",
        subtitle: "Narrator, irony, social class, marriage economy, and character judgment.",
        learn: `
          <p><b>What to notice</b></p>
          <ul>
            <li><b>Opening irony:</b> social critique, not a literal fact.</li>
            <li><b>Marriage as system:</b> desire meets economics/status.</li>
            <li><b>Character perception:</b> first impressions distort judgment.</li>
          </ul>

          <div class="note">
            Weak: ‚ÄúIt‚Äôs about love.‚Äù Better: show how love is constrained by <b>class, money, reputation</b>.
          </div>
        `
      },
      {
        id: "review",
        title: "Review Hub",
        subtitle: "Mastery mode: mixed flashcards, quizzes, and mind maps across all modules.",
        learn: `
          <p><b>Use this to finish strong</b></p>
          <ul>
            <li>Mixed flashcards (review-level only) until weak points shrink.</li>
            <li>Mixed quizzes ‚Üí turn wrong answers into flashcards.</li>
            <li>Mind maps to rehearse frameworks.</li>
          </ul>

          <div class="note">
            Recognition is not mastery. If students can‚Äôt produce answers from memory, they‚Äôre not ready.
          </div>
        `
      }
    ];

    /**********************
     * DATA: Flashcards (50)
     **********************/
    const baseCards = [
      { id:"c1", module:"m1", term:"Literature", def:"Language shaped to create meaning/experience and effects beyond plain information.", level:0 },
      { id:"c2", module:"m1", term:"Genre", def:"A category of literature with conventions (poetry, drama, fiction).", level:0 },
      { id:"c3", module:"m1", term:"Function of literature", def:"To entertain, represent culture, question power, persuade, and intensify experience.", level:0 },
      { id:"c4", module:"m1", term:"Interpretation", def:"Explaining how textual choices create meaning (not guessing author intent).", level:0 },

      { id:"c5", module:"m2", term:"Figure of speech", def:"Non-literal language used for rhetorical/vivid effect.", level:0 },
      { id:"c6", module:"m2", term:"Denotation", def:"Basic dictionary meaning.", level:0 },
      { id:"c7", module:"m2", term:"Connotation", def:"Associated meanings/feelings attached to a word.", level:0 },
      { id:"c8", module:"m2", term:"Tone", def:"Speaker‚Äôs attitude (ironic, joyful, bitter‚Ä¶).", level:0 },
      { id:"c9", module:"m2", term:"Theme", def:"Central idea/claim developed by the text.", level:0 },
      { id:"c10", module:"m2", term:"Motif", def:"Recurring element that supports theme.", level:0 },

      { id:"c11", module:"m3", term:"Alliteration", def:"Repetition of initial consonant sounds.", level:0 },
      { id:"c12", module:"m3", term:"Assonance", def:"Repetition of vowel sounds.", level:0 },
      { id:"c13", module:"m3", term:"Consonance", def:"Repetition of consonant sounds.", level:0 },
      { id:"c14", module:"m3", term:"Irony", def:"Contrast between expectation and reality (or words and intended meaning).", level:0 },
      { id:"c15", module:"m3", term:"Allusion", def:"Reference to a known text/event/person that adds meaning.", level:0 },

      { id:"c16", module:"m4", term:"Speaker", def:"The voice in a poem (not always the poet).", level:0 },
      { id:"c17", module:"m4", term:"Stanza", def:"A grouped set of lines in a poem (like a paragraph).", level:0 },
      { id:"c18", module:"m4", term:"Meter", def:"Patterned rhythm of stressed/unstressed syllables.", level:0 },
      { id:"c19", module:"m4", term:"Form", def:"Structural pattern (stanza/line scheme) shaping pace and emphasis.", level:0 },

      { id:"c20", module:"m5", term:"Close reading", def:"Detailed analysis of patterns (imagery/sound/structure) to infer meaning and effect.", level:0 },

      { id:"c21", module:"m6", term:"Stage directions", def:"Instructions for movement/setting/action/tone in a play.", level:0 },
      { id:"c22", module:"m6", term:"Conflict", def:"Central struggle driving dramatic action.", level:0 },

      { id:"c23", module:"m7", term:"Inference", def:"Reasoned conclusion drawn from textual evidence (details ‚Üí interpretation).", level:0 },
      { id:"c24", module:"m7", term:"Subtext", def:"Meaning implied beneath what characters explicitly say/do.", level:0 },

      { id:"c25", module:"m8", term:"Plot", def:"Event structure with causality (conflict ‚Üí tension ‚Üí outcome).", level:0 },
      { id:"c26", module:"m8", term:"Point of view", def:"Who tells/sees; shapes reliability and interpretation.", level:0 },
      { id:"c27", module:"m8", term:"Setting", def:"Time/place + social world; can shape character and symbolize theme.", level:0 },
    ];

    const generatedCardSpecs = [
      ["m2","Simile","Comparison using 'like' or 'as'."],
      ["m2","Metaphor","Direct comparison: one thing is another."],
      ["m2","Analogy","Extended comparison used to explain."],
      ["m2","Imagery","Sensory description building vivid mental scenes."],
      ["m2","Personification","Human qualities given to non-human things/ideas."],
      ["m2","Onomatopoeia","Words that imitate sounds (buzz, hiss, tick)."],

      ["m3","Symbol","Object/action representing more than itself."],
      ["m3","Hyperbole","Deliberate exaggeration for emphasis."],
      ["m3","Understatement","Intentional downplaying (often ironic)."],
      ["m3","Rhyme","Repetition of similar end sounds."],
      ["m3","Rhythm","Patterned flow shaping pace/mood."],

      ["m4","Diction","Word choice; carries tone and connotation."],
      ["m4","Syntax","Word order; shapes emphasis and meaning."],
      ["m4","Enjambment","Line break without punctuation; drives momentum."],
      ["m4","End-stopped line","Line ends with punctuation; creates pause."],

      ["m8","Characterization","How characters are built (actions/speech/thoughts/others‚Äô views)."],
      ["m8","Foreshadowing","Hints preparing for later events."],
      ["m8","Climax","Peak moment of tension/turning point."],
      ["m8","Resolution","Ending phase settling conflict (or leaving it open)."],
      ["m8","Novel","Extended fictional prose narrative (often 40,000+ words)."],
      ["m8","Novella","Between short story and novel (often 10k‚Äì40k words)."],
      ["m8","Short story","Focused fiction often read in one sitting (often 1k‚Äì10k words)."],

      ["m9","Irony (Austen)","Narration implies critique beneath polite social language."],
      ["m9","Marriage economy","Marriage linked to money/property/social survival."],
      ["m9","Social class","Rank/status shaping reputation and life choices."],

      ["m1","Canon","Texts traditionally treated as central/important."],
      ["review","Evidence ‚Üí Claim","State a claim, cite a detail, explain the link (not summary)."],
    ];

    const flashcards = (() => {
      const cards = [...baseCards];
      let nextId = 28;
      for (const [module, term, def] of generatedCardSpecs){
        cards.push({ id:`c${nextId++}`, module, term, def, level:0 });
      }
      while (cards.length < 50){
        cards.push({ id:`c${nextId++}`, module:"review", term:`Practice Prompt ${cards.length+1}`, def:"Explain how a specific detail creates an effect (tone, mood, theme).", level:0 });
      }
      return cards.slice(0,50);
    })();

    /**********************
     * DATA: Quizzes (50) ‚Äî same logic, shortened here for space but still 50
     **********************/
    const baseQuizzes = [
      { id:"q1", module:"m1", q:"Literature is best described as‚Ä¶", type:"mcq",
        opts:["Language shaped for meaning and effect","A list of historical facts","Only poetry","Only fictional stories"], ans:0,
        why:"Literature is language crafted for meaning/experience and effect." },
      { id:"q2", module:"m1", q:"Which is NOT a major genre?", type:"mcq",
        opts:["Poetry","Drama","Fiction","Algebra"], ans:3, why:"Algebra is not a literary genre." },
      { id:"q3", module:"m2", q:"A simile compares two things using‚Ä¶", type:"mcq",
        opts:["like/as","a footnote","only rhyme","stage directions"], ans:0, why:"Similes use 'like' or 'as'." },
      { id:"q4", module:"m2", q:"True/False: A metaphor uses 'like' or 'as'.", type:"tf",
        opts:["True","False"], ans:1, why:"Metaphor is direct comparison without 'like/as'." },
      { id:"q5", module:"m2", q:"Theme is best defined as‚Ä¶", type:"mcq",
        opts:["The topic alone","A central claim/idea developed by the text","A character‚Äôs name","The number of lines"], ans:1,
        why:"Theme is the text‚Äôs central claim/idea, not just a topic." },
      { id:"q6", module:"m3", q:"Alliteration is‚Ä¶", type:"mcq",
        opts:["Repeated initial consonant sounds","Repeated vowel sounds","A plot twist","A stage prop"], ans:0,
        why:"Alliteration repeats initial consonant sounds." },
      { id:"q7", module:"m3", q:"Assonance is‚Ä¶", type:"mcq",
        opts:["Repeated vowel sounds","Repeated end rhyme only","A character flaw","A scene change"], ans:0,
        why:"Assonance repeats vowel sounds." },
      { id:"q8", module:"m4", q:"In poetry, the 'speaker' is‚Ä¶", type:"mcq",
        opts:["Always the poet","The voice speaking in the poem","The rhyme scheme","The stanza count"], ans:1,
        why:"The speaker is the poem‚Äôs voice." },
      { id:"q9", module:"m6", q:"Stage directions primarily‚Ä¶", type:"mcq",
        opts:["Describe action/setting/performance","Give dictionary definitions","Explain algebra rules","Replace dialogue"], ans:0,
        why:"Stage directions guide performance." },
      { id:"q10", module:"m8", q:"Point of view affects‚Ä¶", type:"mcq",
        opts:["What is seen/told and how reliable it is","Only the cover design","Only the author‚Äôs biography","Only stanza length"], ans:0,
        why:"POV shapes access and reliability." },
    ];

    const quizGenerators = [
      () => ({module:"m2", q:"Denotation refers to‚Ä¶", type:"mcq",
              opts:["Basic dictionary meaning","Emotional associations","A rhyme pattern","A plot summary"], ans:0,
              why:"Denotation = basic meaning."}),
      () => ({module:"m2", q:"Connotation refers to‚Ä¶", type:"mcq",
              opts:["Emotional/cultural associations","Only dictionary meaning","Only meter","Only scene structure"], ans:0,
              why:"Connotation = associations."}),
      () => ({module:"m3", q:"True/False: Consonance repeats consonant sounds.", type:"tf",
              opts:["True","False"], ans:0, why:"That‚Äôs the definition."}),
      () => ({module:"m4", q:"Meter is primarily about‚Ä¶", type:"mcq",
              opts:["Rhythmic stress pattern","Plot structure","Character names","Setting only"], ans:0,
              why:"Meter = stress pattern."}),
      () => ({module:"m6", q:"Drama differs from fiction mainly because drama is written for‚Ä¶", type:"mcq",
              opts:["Performance","Silent reading only","Word counts","Rhyming"], ans:0,
              why:"Drama is meant to be performed."}),
      () => ({module:"m7", q:"In 'Trifles', meaning often comes from‚Ä¶", type:"mcq",
              opts:["Small details treated as evidence","Only long speeches","Only the title","Random guessing"], ans:0,
              why:"Details function as clues."}),
      () => ({module:"m8", q:"Foreshadowing is‚Ä¶", type:"mcq",
              opts:["Hints about later events","A stanza type","A stage prop","A rhyme error"], ans:0,
              why:"Foreshadowing hints at later events."}),
      () => ({module:"m9", q:"The opening of Pride & Prejudice is best read as‚Ä¶", type:"mcq",
              opts:["Irony/social critique","A biology fact","A stage direction","A literal law"], ans:0,
              why:"The opening signals critique."}),
    ];

    const quizzes = (() => {
      const list = [...baseQuizzes];
      let nextId = 11;
      let gi = 0;
      while (list.length < 50){
        const item = quizGenerators[gi % quizGenerators.length]();
        item.id = `q${nextId++}`;
        list.push(item);
        gi++;
      }
      return list.slice(0,50);
    })();

    /**********************
     * DATA: Mind maps (25)
     **********************/
    const mindmapsFull = (() => {
      const base = [
        { id:"mm1", module:"m1", title:"Genres Overview",
          tree: [["Literature", [["Poetry",["Sound","Imagery","Form","Speaker"]],["Drama",["Dialogue","Stage directions","Conflict"]],["Fiction",["Plot","Character","Setting","POV","Theme"]]]]],
          jumps: [{label:"Jump to Poetry", to:"m4"},{label:"Jump to Drama", to:"m6"},{label:"Jump to Fiction", to:"m8"}]
        },
        { id:"mm2", module:"m2", title:"Literal vs Figurative",
          tree: [["Literal",["Direct meaning"]],["Figurative",["Simile","Metaphor","Symbol","Personification","Irony"]]],
          jumps: [{label:"Go to Figures & Sound", to:"m3"}]
        },
        { id:"mm3", module:"m3", title:"Sound Devices",
          tree: [["Sound", [["Rhyme",["End","Internal"]],["Repetition",["Alliteration","Assonance","Consonance"]],["Rhythm/Meter",["Pace","Mood"]]]]],
          jumps: [{label:"Go to Poetry", to:"m4"}]
        },
        { id:"mm4", module:"m4", title:"Poetry Elements",
          tree: [["Poem", [["Speaker"],["Diction & Syntax"],["Imagery"],["Sound"],["Form"],["Theme"]]]],
          jumps: [{label:"Go to Shakespeare", to:"m5"}]
        },
        { id:"mm5", module:"m8", title:"Fiction Elements",
          tree: [["Fiction", [["Plot",["Conflict","Climax","Resolution"]],["Character"],["Setting"],["POV"],["Theme"]]]],
          jumps: [{label:"Go to Austen", to:"m9"}]
        },
      ];

      let n = 6;
      const add = (module,title,tree)=>({id:`mm${n++}`,module,title,tree,jumps:[]});
      const list = [...base];

      const extras = [
        add("m6","Drama Elements",[["Drama",[["Dialogue",["Conflict","Character"]],["Stage directions",["Setting","Movement"]],["Structure",["Scenes","Acts"]]]]]),
        add("m7","Trifles: Evidence Logic",[["Details",[["Objects",["Clues","Meaning"]],["Interpretation",["Official","Overlooked"]]]]]),
        add("m9","Austen: Social System",[["Society",[["Class"],["Marriage economy"],["Reputation"]]]]]),
        add("review","Revision Strategy",[["Mastery",[["Recall",["Flashcards","Short answers"]],["Feedback",["Fix errors"]],["Frameworks",["Mind maps"]]]]]),
      ];

      list.push(...extras);

      while (list.length < 25){
        list.push(add("review",`Rapid Map ${list.length+1}`,[["Core",[["Genres"],["Devices"],["Elements"],["Evidence ‚Üí Claim"]]]] ));
      }
      return list.slice(0,25);
    })();

    /**********************
     * STATE (Progress)
     **********************/
    const STORE_KEY = "ENGL280_PROGRESS_V3";

    const defaultProgress = {
      cardLevel: Object.fromEntries(flashcards.map(c => [c.id, 0])),
      quizCorrect: Object.fromEntries(quizzes.map(q => [q.id, false])),
      mapVisited: Object.fromEntries(mindmapsFull.map(m => [m.id, false])),
      bookmarks: [],
      lastActiveDate: null,
      streak: 0,
      lastModule: "home"
    };

    function loadProgress(){
      try{
        const raw = localStorage.getItem(STORE_KEY);
        if (!raw) return structuredClone(defaultProgress);
        const parsed = JSON.parse(raw);
        return {
          ...structuredClone(defaultProgress),
          ...parsed,
          cardLevel: { ...structuredClone(defaultProgress.cardLevel), ...(parsed.cardLevel||{}) },
          quizCorrect: { ...structuredClone(defaultProgress.quizCorrect), ...(parsed.quizCorrect||{}) },
          mapVisited: { ...structuredClone(defaultProgress.mapVisited), ...(parsed.mapVisited||{}) },
          bookmarks: Array.isArray(parsed.bookmarks) ? parsed.bookmarks : []
        };
      }catch{
        return structuredClone(defaultProgress);
      }
    }
    function saveProgress(){
      localStorage.setItem(STORE_KEY, JSON.stringify(progress));
      renderProgress();
    }

    let progress = loadProgress();

    function todayISO(){
      const d = new Date();
      d.setHours(0,0,0,0);
      return d.toISOString().slice(0,10);
    }

    function updateStreak(){
      const t = todayISO();
      if (!progress.lastActiveDate){
        progress.lastActiveDate = t;
        progress.streak = 1;
        saveProgress();
        return;
      }
      if (progress.lastActiveDate === t) return;

      const last = new Date(progress.lastActiveDate + "T00:00:00");
      const now = new Date(t + "T00:00:00");
      const diffDays = Math.round((now - last) / (1000*60*60*24));

      if (diffDays === 1) progress.streak = (progress.streak || 0) + 1;
      else progress.streak = 1;

      progress.lastActiveDate = t;
      saveProgress();
    }

    /**********************
     * UI Refs
     **********************/
    const navEl = document.getElementById("nav");
    const pageTitleEl = document.getElementById("pageTitle");
    const pageSubEl = document.getElementById("pageSubtitle");
    const learnBody = document.getElementById("learnBody");
    const toolsBody = document.getElementById("toolsBody");

    const progressFill = document.getElementById("progressFill");
    const statCards = document.getElementById("statCards");
    const statQuizzes = document.getElementById("statQuizzes");
    const statMaps = document.getElementById("statMaps");
    const statStreak = document.getElementById("statStreak");

    const searchInput = document.getElementById("searchInput");
    const nextBtn = document.getElementById("nextBtn");
    const bookmarkBtn = document.getElementById("bookmarkBtn");
    const quickPracticeBtn = document.getElementById("quickPracticeBtn");

    const focusBtn = document.getElementById("focusBtn");
    const musicBtn = document.getElementById("musicBtn");
    const startMusicTopBtn = document.getElementById("startMusicTopBtn");
    const resetBtn = document.getElementById("resetBtn");

    const modeChips = document.getElementById("modeChips");

    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const openDashboardBtn = document.getElementById("openDashboardBtn");

    let currentModuleId = progress.lastModule || "home";
    let currentMode = "learn";

    /**********************
     * NAV + MODULE
     **********************/
    function moduleLabel(m){
      if (m.id === "home") return "Home";
      if (m.id === "review") return "Review";
      return m.title.replace(/^Module\s+\d+:\s+/i,"").trim();
    }

    function renderNav(filterText=""){
      navEl.innerHTML = "";
      const q = filterText.trim().toLowerCase();
      const items = modules.filter(m => {
        if (!q) return true;
        const hay = (m.title + " " + (m.subtitle||"") + " " + (m.learn||"")).toLowerCase();
        return hay.includes(q);
      });

      for (const m of items){
        const btn = document.createElement("button");
        btn.className = (m.id === currentModuleId) ? "active" : "";
        btn.innerHTML = `<span>${m.id==="home" ? "üè°" : (m.id==="review" ? "üåø" : "üìñ")} ${moduleLabel(m)}</span><small>${m.id==="home" ? "Start here" : (m.id==="review" ? "Mastery mode" : "Lesson + practice")}</small>`;
        btn.onclick = () => openModule(m.id, true);
        navEl.appendChild(btn);
      }
    }

    function openModule(id, fromUser=false){
      const m = modules.find(x => x.id === id);
      if (!m) return;

      currentModuleId = id;
      progress.lastModule = id;
      saveProgress();

      renderNav(searchInput.value);

      pageTitleEl.textContent = m.title;
      pageSubEl.textContent = m.subtitle || "";

      if (fromUser) currentMode = "learn";
      setActiveChip(currentMode);

      renderMain();
      renderTools();
      updateStreak();
    }

    function setActiveChip(mode){
      [...modeChips.querySelectorAll(".chip")].forEach(c => {
        c.classList.toggle("active", c.dataset.mode === mode);
      });
    }

    modeChips.addEventListener("click", (e) => {
      const chip = e.target.closest(".chip");
      if (!chip) return;
      currentMode = chip.dataset.mode;
      setActiveChip(currentMode);
      renderMain();
    });

    function nextModuleId(){
      const ids = modules.map(m => m.id);
      const i = ids.indexOf(currentModuleId);
      return ids[(i + 1) % ids.length];
    }
    nextBtn.onclick = () => openModule(nextModuleId(), true);

    /**********************
     * Search
     **********************/
    searchInput.addEventListener("input", () => {
      renderNav(searchInput.value);
      renderTools();
    });

    window.addEventListener("keydown", (e) => {
      if (e.ctrlKey && e.key === "/"){
        e.preventDefault();
        searchInput.focus();
      }
      if (e.key.toLowerCase() === "g"){
        window.__awaitingModuleKey = true;
        setTimeout(() => window.__awaitingModuleKey = false, 900);
      } else if (window.__awaitingModuleKey){
        const n = parseInt(e.key,10);
        if (n >= 1 && n <= 9){
          openModule(`m${n}`, true);
          window.__awaitingModuleKey = false;
        }
      }
    });

    /**********************
     * Bookmarks
     **********************/
    bookmarkBtn.onclick = () => {
      const b = progress.bookmarks || [];
      if (!b.includes(currentModuleId)) b.push(currentModuleId);
      else b.splice(b.indexOf(currentModuleId), 1);
      progress.bookmarks = b;
      saveProgress();
      renderTools();
    };

    /**********************
     * Quick Practice
     **********************/
    quickPracticeBtn.onclick = () => {
      openModule("review", true);
      currentMode = "quiz";
      setActiveChip(currentMode);
      renderMain({ mixed:true, count: 6 });
      renderTools();
    };

    /**********************
     * MAIN RENDER
     **********************/
    function renderMain(opts={}){
      const m = modules.find(x => x.id === currentModuleId);
      if (!m) return;

      if (currentMode === "learn"){ learnBody.innerHTML = m.learn || `<p>No content yet.</p>`; return; }
      if (currentMode === "flashcards"){ renderFlashcardsView(m, opts); return; }
      if (currentMode === "quiz"){ renderQuizView(m, opts); return; }
      if (currentMode === "mindmap"){ renderMindmapView(m); return; }
    }

    /**********************
     * FLASHCARDS
     **********************/
    function renderFlashcardsView(m, opts={}){
      const isMixed = (m.id === "review");
      const moduleFilter = isMixed ? null : m.id;
      const levels = opts.levels ?? null;

      const pool = flashcards.filter(c => {
        const okModule = moduleFilter ? c.module === moduleFilter : true;
        const okLevel = levels ? levels.includes(progress.cardLevel[c.id] ?? 0) : true;
        return okModule && okLevel;
      });

      const chosen = (isMixed ? (pool.filter(c => (progress.cardLevel[c.id] ?? 0) === 0) || pool) : pool);
      const use = chosen.length ? chosen : pool;
      const card = shuffle([...use])[0];

      if (!card){
        learnBody.innerHTML = `<div class="note"><b>No flashcards found.</b></div>`;
        return;
      }

      const lvl = progress.cardLevel[card.id] ?? 0;

      learnBody.innerHTML = `
        <div class="deckTop">
          <div class="left">
            <select class="select" id="cardFilter">
              <option value="all">All levels</option>
              <option value="0" ${isMixed ? "selected" : ""}>Review only</option>
              <option value="1">Known only</option>
              <option value="2">Mastered only</option>
            </select>
            <button class="btn primary" id="nextCardBtn">Next card</button>
          </div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;">
            <span class="tag">${isMixed ? "Mixed deck" : "Module deck"}</span>
            <span class="tag">Tap to reveal</span>
          </div>
        </div>

        <div class="flashWrap">
          <div class="flashCard" id="flashCard">
            <div>
              <div class="flashFace">${escapeHTML(card.term)}</div>
              <div class="flashBack">${escapeHTML(card.def)}</div>
            </div>
            <div class="flashMeta">
              <div>
                <span class="tag">Module: ${escapeHTML(card.module.toUpperCase())}</span>
              </div>
              <div class="level">
                <button class="lvlBtn ${lvl===0 ? "active":""}" data-lvl="0">Review</button>
                <button class="lvlBtn ${lvl===1 ? "active":""}" data-lvl="1">Known</button>
                <button class="lvlBtn ${lvl===2 ? "active":""}" data-lvl="2">Mastered</button>
              </div>
            </div>
          </div>

          <div class="note">
            <b>Rule:</b> if you needed the back side, don‚Äôt mark ‚ÄúMastered.‚Äù Be honest.
          </div>
        </div>
      `;

      const flashEl = document.getElementById("flashCard");
      flashEl.addEventListener("click", (e) => {
        if (e.target.closest(".lvlBtn")) return;
        flashEl.classList.toggle("revealed");
        updateStreak();
      });

      document.getElementById("nextCardBtn").onclick = () => renderFlashcardsView(m, opts);

      const filterSel = document.getElementById("cardFilter");
      filterSel.onchange = () => {
        const v = filterSel.value;
        if (v === "all") renderFlashcardsView(m, { levels:null });
        else renderFlashcardsView(m, { levels:[parseInt(v,10)] });
      };

      [...document.querySelectorAll(".lvlBtn")].forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          progress.cardLevel[card.id] = parseInt(btn.dataset.lvl,10);
          saveProgress();
          renderFlashcardsView(m, opts);
        };
      });
    }

    /**********************
     * QUIZ
     **********************/
    function renderQuizView(m, opts={}){
      const isMixed = (m.id === "review");
      const moduleFilter = isMixed ? null : m.id;

      let pool = quizzes.filter(q => moduleFilter ? q.module === moduleFilter : true);
      pool = shuffle(pool).slice(0, (isMixed && opts.mixed) ? (opts.count ?? 6) : 4);

      if (!pool.length){
        learnBody.innerHTML = `<div class="note"><b>No quizzes found.</b></div>`;
        return;
      }

      learnBody.innerHTML = `
        <div class="deckTop">
          <div class="left">
            <button class="btn" id="newQuizSetBtn">New set</button>
            <button class="btn" id="reviewWrongsBtn">Practice wrong ones</button>
          </div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;">
            <span class="tag">${isMixed ? "Mixed quiz" : "Module quiz"}</span>
            <span class="tag">Total: ${quizzes.length}</span>
          </div>
        </div>
        <div id="quizList"></div>
        <div class="note">
          <b>Truth:</b> guessing feels like learning. It isn‚Äôt. Fix wrong items immediately.
        </div>
      `;

      const listEl = document.getElementById("quizList");

      pool.forEach(q => {
        const alreadyCorrect = !!progress.quizCorrect[q.id];
        const qEl = document.createElement("div");
        qEl.className = "qBox";
        qEl.innerHTML = `
          <div class="qTop">
            <h4>${escapeHTML(q.q)}</h4>
            <div class="qMeta">${escapeHTML(q.module.toUpperCase())} ¬∑ ${alreadyCorrect ? "‚úÖ Correct before" : "Not yet"}</div>
          </div>
          <div class="qOpts" data-qid="${q.id}">
            ${renderQuizOptions(q)}
          </div>
          <button class="btn primary" data-action="check" data-qid="${q.id}">Check</button>
          <div class="feedback" id="fb_${q.id}" style="display:none;"></div>
        `;
        listEl.appendChild(qEl);
      });

      document.getElementById("newQuizSetBtn").onclick = () => renderQuizView(m, opts);

      document.getElementById("reviewWrongsBtn").onclick = () => {
        const wrongs = quizzes.filter(q => !progress.quizCorrect[q.id] && (moduleFilter ? q.module === moduleFilter : true));
        if (!wrongs.length){
          learnBody.innerHTML = `<div class="note"><b>No wrong questions left in this scope.</b></div>`;
          return;
        }
        // Force 6 wrong ones
        const forced = shuffle(wrongs).slice(0, Math.min(6, wrongs.length));
        // Quick rerender with forced list
        learnBody.querySelector("#quizList").innerHTML = "";
        forced.forEach(q => {
          const qEl = document.createElement("div");
          qEl.className = "qBox";
          qEl.innerHTML = `
            <div class="qTop">
              <h4>${escapeHTML(q.q)}</h4>
              <div class="qMeta">${escapeHTML(q.module.toUpperCase())} ¬∑ Not yet</div>
            </div>
            <div class="qOpts" data-qid="${q.id}">
              ${renderQuizOptions(q)}
            </div>
            <button class="btn primary" data-action="check" data-qid="${q.id}">Check</button>
            <div class="feedback" id="fb_${q.id}" style="display:none;"></div>
          `;
          learnBody.querySelector("#quizList").appendChild(qEl);
        });
      };

      listEl.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-action='check']");
        if (!btn) return;
        const qid = btn.dataset.qid;
        const q = quizzes.find(x => x.id === qid);
        if (!q) return;

        const fb = document.getElementById(`fb_${qid}`);
        const user = getQuizUserAnswer(qid);
        const correct = (user !== null) && (user === q.ans);

        fb.style.display = "block";
        fb.className = "feedback " + (correct ? "good" : "bad");
        fb.innerHTML = correct
          ? `‚úÖ <b>Correct.</b> ${escapeHTML(q.why)}`
          : `‚ùå <b>Incorrect.</b> ${escapeHTML(q.why)}`;

        if (correct){
          progress.quizCorrect[qid] = true;
          saveProgress();
        }
        updateStreak();
      }, { once:false });
    }

    function renderQuizOptions(q){
      return q.opts.map((opt, j) => `
        <label class="opt">
          <input type="radio" name="quiz_${q.id}" value="${j}">
          <span>${escapeHTML(opt)}</span>
        </label>
      `).join("");
    }

    function getQuizUserAnswer(qid){
      const checked = document.querySelector(\`input[name="quiz_\${qid}"]:checked\`);
      if (!checked) return null;
      return parseInt(checked.value,10);
    }

    /**********************
     * MIND MAPS
     **********************/
    function renderMindmapView(m){
      const isMixed = (m.id === "review");
      const moduleFilter = isMixed ? null : m.id;

      const pool = mindmapsFull.filter(mm => moduleFilter ? mm.module === moduleFilter : true);
      const list = pool.length ? pool : mindmapsFull;

      learnBody.innerHTML = `
        <div class="deckTop">
          <div class="left">
            <button class="btn" id="openAllMapsBtn">Open all</button>
            <button class="btn" id="markAllVisitedBtn">Mark visited</button>
          </div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;">
            <span class="tag">${isMixed ? "All maps" : "Module maps"}</span>
            <span class="tag">Total: ${mindmapsFull.length}</span>
          </div>
        </div>

        <div class="mapList" id="mapList"></div>
      `;

      const listEl = document.getElementById("mapList");

      list.forEach(mm => {
        const visited = !!progress.mapVisited[mm.id];
        const det = document.createElement("details");
        det.className = "map";
        det.innerHTML = `
          <summary>
            <span>${visited ? "‚úÖ" : "üß©"} ${escapeHTML(mm.title)} <span style="color:var(--muted);font-size:14px;">(${escapeHTML(mm.module.toUpperCase())})</span></span>
            <span class="tag">${visited ? "visited" : "new"}</span>
          </summary>
          <div class="mapBody">
            ${renderTree(mm.tree)}
            ${mm.jumps?.length ? `<div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">${mm.jumps.map(j => `<a class="jump" href="#" data-jump="${j.to}">${escapeHTML(j.label)}</a>`).join("")}</div>` : ""}
          </div>
        `;
        det.addEventListener("toggle", () => {
          if (det.open){
            progress.mapVisited[mm.id] = true;
            saveProgress();
            updateStreak();
          }
        });
        listEl.appendChild(det);
      });

      listEl.addEventListener("click", (e) => {
        const a = e.target.closest("a[data-jump]");
        if (!a) return;
        e.preventDefault();
        openModule(a.dataset.jump, true);
      });

      document.getElementById("openAllMapsBtn").onclick = () => {
        [...document.querySelectorAll("details.map")].forEach(d => d.open = true);
      };
      document.getElementById("markAllVisitedBtn").onclick = () => {
        list.forEach(mm => progress.mapVisited[mm.id] = true);
        saveProgress();
        renderMindmapView(m);
      };
    }

    function renderTree(tree){
      const renderNode = (node) => {
        if (Array.isArray(node)){
          const [label, children] = node;
          return `<li><b>${escapeHTML(label)}</b>${children ? `<ul class="tree">${children.map(renderNode).join("")}</ul>` : ""}</li>`;
        } else {
          return `<li>${escapeHTML(String(node))}</li>`;
        }
      };
      return `<ul class="tree">${tree.map(renderNode).join("")}</ul>`;
    }

    /**********************
     * TOOLS
     **********************/
    function renderTools(){
      const m = modules.find(x => x.id === currentModuleId);
      const bookmarked = (progress.bookmarks || []).includes(currentModuleId);
      const q = searchInput.value.trim().toLowerCase();

      const moduleCards = flashcards.filter(c => c.module === m.id).length;
      const moduleQuizzes = quizzes.filter(qz => qz.module === m.id).length;
      const moduleMaps = mindmapsFull.filter(mm => mm.module === m.id).length;

      toolsBody.innerHTML = `
        <div class="chips" style="margin-bottom:12px;">
          <div class="chip ${currentMode==="learn"?"active":""}" data-tmode="learn">Lesson</div>
          <div class="chip ${currentMode==="flashcards"?"active":""}" data-tmode="flashcards">Flashcards</div>
          <div class="chip ${currentMode==="quiz"?"active":""}" data-tmode="quiz">Quiz</div>
          <div class="chip ${currentMode==="mindmap"?"active":""}" data-tmode="mindmap">Mind Map</div>
        </div>

        <div class="note" style="margin-top:0;">
          <b>${bookmarked ? "‚òÖ Bookmarked" : "‚òÜ Not bookmarked"}</b><br/>
          ${m.id==="home" ? "Start here, then go module by module." : (m.id==="review" ? "Mixed mastery across the whole course." : "Lesson ‚Üí Cards ‚Üí Quiz ‚Üí Mind map.")}<br/>
          <span style="display:block;margin-top:8px;">
            <b>Counts:</b> ${m.id==="home" || m.id==="review"
              ? `Cards: 50 ¬∑ Quizzes: 50 ¬∑ Maps: 25`
              : `Cards: ${moduleCards} ¬∑ Quizzes: ${moduleQuizzes} ¬∑ Maps: ${moduleMaps}`
            }
          </span>
          <span style="display:block;margin-top:8px;">
            <b>Music:</b> click <b>Music</b> (browser requires interaction).
          </span>
        </div>

        <div style="display:grid;gap:10px;margin-top:12px;">
          <button class="btn primary" id="mixedCardsBtn">Mixed flashcards (weak only)</button>
          <button class="btn" id="mixedQuizBtn">Mixed quiz (6 questions)</button>
          <button class="btn primary" id="musicSmallBtn">Start / Stop Music</button>
        </div>

        ${q ? `<div class="note"><b>Search active:</b> ‚Äú${escapeHTML(q)}‚Äù</div>` : ""}
      `;

      toolsBody.addEventListener("click", (e) => {
        const chip = e.target.closest(".chip[data-tmode]");
        if (chip){
          currentMode = chip.dataset.tmode;
          setActiveChip(currentMode);
          renderMain();
          renderTools();
        }
      }, { once:true });

      document.getElementById("mixedCardsBtn").onclick = () => {
        openModule("review", true);
        currentMode = "flashcards";
        setActiveChip(currentMode);
        renderMain({ levels:[0] });
      };
      document.getElementById("mixedQuizBtn").onclick = () => {
        openModule("review", true);
        currentMode = "quiz";
        setActiveChip(currentMode);
        renderMain({ mixed:true, count:6 });
      };
      document.getElementById("musicSmallBtn").onclick = () => toggleMusic();
    }

    /**********************
     * PROGRESS
     **********************/
    function renderProgress(){
      const mastered = Object.values(progress.cardLevel).filter(v => v === 2).length;
      const quizOK = Object.values(progress.quizCorrect).filter(Boolean).length;
      const maps = Object.values(progress.mapVisited).filter(Boolean).length;

      statCards.textContent = mastered;
      statQuizzes.textContent = quizOK;
      statMaps.textContent = maps;
      statStreak.textContent = progress.streak || 0;

      const total = (50 + 50 + 25);
      const score = mastered + quizOK + maps;
      const pct = Math.round((score / total) * 100);
      progressFill.style.width = pct + "%";
    }

    /**********************
     * DASHBOARD MODAL (minimal)
     **********************/
    openDashboardBtn.onclick = () => {
      modalBackdrop.style.display = "flex";
      modalBackdrop.setAttribute("aria-hidden","false");
      modalTitle.textContent = "Learning Dashboard";
      modalBody.innerHTML = `<div class="note"><b>Use Review Hub</b> to drill weak flashcards and wrong quizzes until they disappear.</div>`;
    };
    closeModalBtn.onclick = closeModal;
    modalBackdrop.addEventListener("click", (e) => { if (e.target === modalBackdrop) closeModal(); });
    function closeModal(){
      modalBackdrop.style.display = "none";
      modalBackdrop.setAttribute("aria-hidden","true");
    }

    /**********************
     * Focus + Reset
     **********************/
    focusBtn.onclick = () => {
      const app = document.querySelector(".app");
      const sidebar = document.querySelector(".sidebar");
      if (!sidebar) return;
      if (sidebar.style.display === "none"){
        sidebar.style.display = "";
        app.style.gridTemplateColumns = "360px 1fr";
      } else {
        sidebar.style.display = "none";
        app.style.gridTemplateColumns = "1fr";
      }
    };

    resetBtn.onclick = () => {
      if (!confirm("Reset all progress? This cannot be undone.")) return;
      localStorage.removeItem(STORE_KEY);
      progress = loadProgress();
      renderProgress();
      openModule("home", true);
    };

    /**********************
     * BACKGROUND MUSIC (WebAudio Nature Ambience)
     * - wind (filtered noise)
     * - soft pad (sine cluster)
     * - bird chirps (short sine bursts with envelope)
     **********************/
    let audioCtx = null;
    let musicOn = false;
    let nodes = [];

    async function ensureAudio(){
      audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === "suspended") await audioCtx.resume();
    }

    function startMusic(){
      if (musicOn) return;
      musicOn = true;

      const ctx = audioCtx;
      const master = ctx.createGain();
      master.gain.value = 0.06;   // overall volume
      master.connect(ctx.destination);

      // Wind noise
      const bufferSize = 2 * ctx.sampleRate;
      const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const out = noiseBuffer.getChannelData(0);
      for (let i=0;i<bufferSize;i++) out[i] = (Math.random()*2-1) * 0.25;

      const noise = ctx.createBufferSource();
      noise.buffer = noiseBuffer;
      noise.loop = true;

      const windFilter = ctx.createBiquadFilter();
      windFilter.type = "lowpass";
      windFilter.frequency.value = 500;

      const windGain = ctx.createGain();
      windGain.gain.value = 0.7;

      // slow modulation for wind
      const lfo = ctx.createOscillator();
      lfo.type = "sine";
      lfo.frequency.value = 0.08;

      const lfoGain = ctx.createGain();
      lfoGain.gain.value = 140;
      lfo.connect(lfoGain);
      lfoGain.connect(windFilter.frequency);

      noise.connect(windFilter);
      windFilter.connect(windGain);
      windGain.connect(master);

      // Soft pad
      const padGain = ctx.createGain();
      padGain.gain.value = 0.55;
      padGain.connect(master);

      const freqs = [196, 220, 247, 294]; // gentle chord-ish
      const oscs = freqs.map(f => {
        const o = ctx.createOscillator();
        o.type = "sine";
        o.frequency.value = f;
        const g = ctx.createGain();
        g.gain.value = 0.12;
        o.connect(g);
        g.connect(padGain);
        return {o,g};
      });

      // Bird chirps scheduler
      let chirpTimer = null;
      function chirp(){
        if (!musicOn) return;

        const t = ctx.currentTime;
        const o = ctx.createOscillator();
        const g = ctx.createGain();

        o.type = "sine";
        o.frequency.setValueAtTime(900 + Math.random()*900, t);
        o.frequency.exponentialRampToValueAtTime(1200 + Math.random()*1200, t + 0.09);

        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(0.20, t + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, t + 0.14);

        const birdFilter = ctx.createBiquadFilter();
        birdFilter.type = "highpass";
        birdFilter.frequency.value = 600;

        o.connect(birdFilter);
        birdFilter.connect(g);
        g.connect(master);

        o.start(t);
        o.stop(t + 0.16);

        // schedule next chirp (random spacing)
        const next = 900 + Math.random()*2200; // ms
        chirpTimer = setTimeout(chirp, next);
      }
      chirp();

      // Start everything
      noise.start();
      lfo.start();
      oscs.forEach(x => x.o.start());

      nodes = [master, noise, windFilter, windGain, lfo, lfoGain, padGain, ...oscs.map(x=>x.o)];
      musicBtn.textContent = "Music: ON";
      startMusicTopBtn.textContent = "Music ON";
      nodes.__chirpTimer = () => chirpTimer;
    }

    function stopMusic(){
      if (!musicOn) return;
      musicOn = false;

      try{
        // stop oscillators/buffers
        nodes.forEach(n => {
          if (n && typeof n.stop === "function"){
            try{ n.stop(0); }catch{}
          }
        });
      }catch{}

      // stop chirp timer if exists
      const timerFn = nodes.__chirpTimer;
      if (timerFn){
        const t = timerFn();
        if (t) clearTimeout(t);
      }

      nodes = [];
      musicBtn.textContent = "Music";
      startMusicTopBtn.textContent = "Start Music";
    }

    async function toggleMusic(){
      await ensureAudio();
      if (!musicOn) startMusic();
      else stopMusic();
      updateStreak();
    }

    musicBtn.onclick = () => toggleMusic();
    startMusicTopBtn.onclick = () => toggleMusic();

    /**********************
     * BACKGROUND CANVAS (Bright Nature: sun + clouds + floating leaves)
     **********************/
    const canvas = document.getElementById("bgCanvas");
    const ctx2 = canvas.getContext("2d");
    let W=0,H=0, DPR=1;

    function resize(){
      DPR = devicePixelRatio || 1;
      W = canvas.width = window.innerWidth * DPR;
      H = canvas.height = window.innerHeight * DPR;
      canvas.style.width = window.innerWidth+"px";
      canvas.style.height = window.innerHeight+"px";
    }
    window.addEventListener("resize", resize);
    resize();

    const leaves = [];
    const clouds = [];
    const pollen = [];

    function rand(a,b){ return a + Math.random()*(b-a); }

    function initBg(){
      leaves.length = 0;
      clouds.length = 0;
      pollen.length = 0;

      const leafCount = Math.round(Math.min(48, Math.max(18, window.innerWidth / 26)));
      const cloudCount = Math.round(Math.min(10, Math.max(5, window.innerWidth / 220)));
      const pollenCount = Math.round(Math.min(90, Math.max(40, window.innerWidth / 18)));

      for (let i=0;i<leafCount;i++){
        leaves.push({
          x: rand(0, W),
          y: rand(0, H),
          r: rand(10, 24) * DPR,
          s: rand(0.35, 1.05) * DPR,
          rot: rand(0, Math.PI*2),
          drot: rand(-0.012, 0.012),
          sway: rand(0.6, 2.2) * DPR,
        });
      }

      for (let i=0;i<cloudCount;i++){
        clouds.push({
          x: rand(0, W),
          y: rand(0, H*0.45),
          w: rand(180, 320) * DPR,
          h: rand(60, 110) * DPR,
          vx: rand(0.04, 0.12) * DPR,
          a: rand(0.08, 0.16)
        });
      }

      for (let i=0;i<pollenCount;i++){
        pollen.push({
          x: rand(0,W),
          y: rand(0,H),
          r: rand(1.3, 3.2) * DPR,
          vx: rand(-0.06, 0.06) * DPR,
          vy: rand(-0.03, 0.10) * DPR,
          a: rand(0.12, 0.24)
        });
      }
    }
    initBg();
    window.addEventListener("resize", initBg);

    function drawSun(){
      const cx = W*0.78, cy = H*0.14;
      const r1 = Math.min(W,H)*0.10;
      const r2 = Math.min(W,H)*0.24;
      const g = ctx2.createRadialGradient(cx,cy,r1, cx,cy,r2);
      g.addColorStop(0, "rgba(255,209,102,0.35)");
      g.addColorStop(1, "rgba(255,209,102,0.00)");
      ctx2.fillStyle = g;
      ctx2.beginPath();
      ctx2.arc(cx,cy,r2,0,Math.PI*2);
      ctx2.fill();
    }

    function drawCloud(c){
      ctx2.save();
      ctx2.translate(c.x, c.y);
      ctx2.fillStyle = `rgba(255,255,255,${c.a})`;
      ctx2.beginPath();
      ctx2.ellipse(0, 0, c.w*0.32, c.h*0.35, 0, 0, Math.PI*2);
      ctx2.ellipse(c.w*0.18, -c.h*0.10, c.w*0.28, c.h*0.30, 0, 0, Math.PI*2);
      ctx2.ellipse(-c.w*0.18, -c.h*0.12, c.w*0.26, c.h*0.28, 0, 0, Math.PI*2);
      ctx2.ellipse(0, -c.h*0.20, c.w*0.22, c.h*0.26, 0, 0, Math.PI*2);
      ctx2.fill();
      ctx2.restore();
    }

    function drawLeaf(l){
      ctx2.save();
      ctx2.translate(l.x, l.y);
      ctx2.rotate(l.rot);

      const grad = ctx2.createRadialGradient(0,0,1, 0,0,l.r);
      grad.addColorStop(0, "rgba(34,197,94,0.22)");
      grad.addColorStop(1, "rgba(0,163,255,0.06)");
      ctx2.fillStyle = grad;

      ctx2.beginPath();
      ctx2.ellipse(0,0, l.r*0.55, l.r, 0, 0, Math.PI*2);
      ctx2.fill();

      ctx2.strokeStyle = "rgba(8,20,12,0.10)";
      ctx2.lineWidth = 1 * DPR;
      ctx2.beginPath();
      ctx2.moveTo(0, -l.r*0.85);
      ctx2.lineTo(0, l.r*0.85);
      ctx2.stroke();

      ctx2.restore();
    }

    function loop(){
      ctx2.clearRect(0,0,W,H);

      // sky haze
      const haze = ctx2.createRadialGradient(W*0.25, H*0.10, 0, W*0.25, H*0.10, Math.min(W,H)*0.55);
      haze.addColorStop(0, "rgba(0,163,255,0.08)");
      haze.addColorStop(1, "rgba(0,0,0,0)");
      ctx2.fillStyle = haze;
      ctx2.fillRect(0,0,W,H);

      drawSun();

      // clouds
      clouds.forEach(c => {
        c.x += c.vx;
        if (c.x > W + c.w) c.x = -c.w;
        drawCloud(c);
      });

      // pollen
      pollen.forEach(p => {
        p.x += p.vx; p.y += p.vy;
        if (p.x < -60) p.x = W+60;
        if (p.x > W+60) p.x = -60;
        if (p.y > H+60) p.y = -60;
        if (p.y < -60) p.y = H+60;

        ctx2.beginPath();
        ctx2.fillStyle = `rgba(255,209,102,${p.a})`;
        ctx2.arc(p.x, p.y, p.r, 0, Math.PI*2);
        ctx2.fill();
      });

      // leaves
      leaves.forEach(l => {
        l.y += l.s;
        l.x += Math.sin(l.y/(90*DPR)) * l.sway * 0.08;
        l.rot += l.drot;
        if (l.y > H + 60) { l.y = -60; l.x = rand(0,W); }
        drawLeaf(l);
      });

      requestAnimationFrame(loop);
    }
    loop();

    /**********************
     * UTIL
     **********************/
    function shuffle(arr){
      for (let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
      return arr;
    }
    function escapeHTML(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    /**********************
     * PROGRESS
     **********************/
    function renderProgress(){
      const mastered = Object.values(progress.cardLevel).filter(v => v === 2).length;
      const quizOK = Object.values(progress.quizCorrect).filter(Boolean).length;
      const maps = Object.values(progress.mapVisited).filter(Boolean).length;

      statCards.textContent = mastered;
      statQuizzes.textContent = quizOK;
      statMaps.textContent = maps;
      statStreak.textContent = progress.streak || 0;

      const total = (50 + 50 + 25);
      const score = mastered + quizOK + maps;
      const pct = Math.round((score / total) * 100);
      progressFill.style.width = pct + "%";
    }

    /**********************
     * INIT
     **********************/
    function init(){
      renderNav("");
      renderProgress();
      openModule(currentModuleId, false);

      // Enter in search opens first match
      searchInput.addEventListener("keydown",(e)=>{
        if (e.key === "Enter"){
          const first = navEl.querySelector("button");
          if (first) first.click();
        }
      });
    }
    init();

    // Keep streak up to date
    updateStreak();

    // Autoplay is blocked; but if user already clicked once, this helps resume
    document.addEventListener("visibilitychange", async () => {
      if (!musicOn || !audioCtx) return;
      if (document.visibilityState === "visible") await ensureAudio();
    });
  </script>

  
</body>
</html>

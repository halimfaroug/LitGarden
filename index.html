<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LitGarden — Offline Literature Lab</title>
  <style>
    :root{
      --bg1:#0b1b1f;
      --bg2:#111827;
      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.06);
      --line: rgba(255,255,255,.14);
      --text: #eef2ff;
      --muted:#c7d2fe;
      --accent:#a7f3d0;
      --accent2:#fbcfe8;
      --accent3:#93c5fd;
      --good:#7CFFB2;
      --bad:#ff6b8a;
      --warn:#ffd37a;
      --shadow: 0 16px 55px rgba(0,0,0,.38);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 12% 10%, rgba(167,243,208,.20), transparent 60%),
        radial-gradient(1000px 700px at 85% 20%, rgba(251,207,232,.18), transparent 60%),
        radial-gradient(1000px 800px at 60% 90%, rgba(147,197,253,.14), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(8,14,20,.65);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .brand{display:flex; gap:12px; align-items:center}
    .mark{
      width:42px;height:42px;border-radius:16px;
      background: linear-gradient(135deg, rgba(167,243,208,.95), rgba(251,207,232,.85));
      box-shadow: 0 12px 35px rgba(0,0,0,.35);
    }
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:12.5px;margin-top:2px}
    nav{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:9px 11px;
      border-radius:14px;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .tab:hover{transform: translateY(-1px)}
    .tab.active{
      border-color: rgba(167,243,208,.55);
      background: rgba(167,243,208,.10);
      box-shadow: inset 0 0 0 1px rgba(167,243,208,.16);
    }

    main{padding:18px}
    .grid{max-width:1200px;margin:0 auto;display:grid;gap:14px;grid-template-columns: 360px 1fr;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, var(--card), var(--card2));
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h2{margin:0 0 8px;font-size:14px;letter-spacing:.2px}
    .muted{color:var(--muted);font-size:12.5px;line-height:1.45}
    .divider{height:1px;background:var(--line);margin:10px 0}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .col{display:flex; flex-direction:column; gap:10px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.14);
      font-size:12px; color:var(--muted);
      font-weight:700;
    }
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:9px 11px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn.primary{
      border-color: rgba(167,243,208,.55);
      background: rgba(167,243,208,.12);
    }
    .btn.pink{
      border-color: rgba(251,207,232,.55);
      background: rgba(251,207,232,.10);
    }
    .btn.danger{
      border-color: rgba(255,107,138,.55);
      background: rgba(255,107,138,.10);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed;transform:none}
    select,input[type="text"],textarea{
      width:100%;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color:var(--text);
      padding:10px 10px;
      border-radius:14px;
      outline:none;
      font-size:13px;
    }
    textarea{min-height:110px; resize:vertical; line-height:1.5}
    .textbox{
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      border-radius:16px;
      padding:12px;
      line-height:1.65;
      font-size:14px;
      overflow:auto;
      max-height:320px;
      white-space:pre-wrap;
    }
    .hidden{display:none !important}

    /* QUIZ */
    .q{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background: rgba(0,0,0,.14);
    }
    .q h3{margin:0 0 8px;font-size:14px}
    .opt{display:flex;gap:8px;align-items:flex-start;margin:6px 0}
    .opt input{margin-top:3px}
    .badge{
      display:inline-flex; align-items:center;
      padding:4px 8px;border-radius:999px;font-weight:900;font-size:11.5px;
      border:1px solid var(--line);
    }
    .badge.good{border-color:rgba(124,255,178,.45); background:rgba(124,255,178,.12); color:var(--good)}
    .badge.bad{border-color:rgba(255,107,138,.45); background:rgba(255,107,138,.12); color:var(--bad)}

    /* FLASHCARDS */
    .cardFace{
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      border-radius:20px;
      padding:18px;
      min-height:200px;
      display:flex; align-items:center; justify-content:center;
      text-align:center;
      font-size:16px;
      line-height:1.5;
      position:relative;
      user-select:none;
    }
    .flipHint{
      position:absolute; bottom:10px; right:12px;
      font-size:12px; color:var(--muted);
      opacity:.9;
    }

    /* MIND MAP */
    #mapCanvas{
      width:100%;
      height:520px;
      border:1px solid var(--line);
      border-radius:20px;
      background:
        radial-gradient(700px 500px at 20% 20%, rgba(167,243,208,.10), transparent 60%),
        radial-gradient(700px 500px at 80% 35%, rgba(251,207,232,.10), transparent 60%),
        rgba(0,0,0,.14);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
      display:block;
      touch-action:none;
    }
    .small{font-size:12px}
    .good{color:var(--good)}
    .bad{color:var(--bad)}
    .warn{color:var(--warn)}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="mark" aria-hidden="true"></div>
        <div>
          <h1>LitGarden</h1>
          <div class="sub">Offline • Quizzes • Flashcards • Mind Maps • Calm ambience</div>
        </div>
      </div>
      <nav id="tabs"></nav>
    </div>
  </div>
</header>

<main>
  <!-- HOME -->
  <section id="view-home" class="grid">
    <div class="card">
      <h2>Library</h2>
      <div class="muted">Pick a short excerpt. Beginners learn faster on small chunks.</div>
      <div class="divider"></div>

      <label class="small muted">Text</label>
      <select id="textSelect"></select>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="goQuiz">Quiz</button>
        <button class="btn pink" id="goCards">Flashcards</button>
        <button class="btn" id="goMap">Mind Map</button>
      </div>

      <div class="divider"></div>
      <h2>Audio</h2>
      <div class="muted small">
        Safe option: built-in ambient generator. If you want “romantic”, upload your own MP3 (you own rights).
      </div>
      <div class="divider"></div>
      <div class="row">
        <button class="btn" id="audioToggle">Start ambience</button>
        <span class="pill">Volume <input id="vol" type="range" min="0" max="1" step="0.01" value="0.35"/></span>
      </div>
      <div class="divider"></div>
      <label class="small muted">Optional: load local audio (your file)</label>
      <input id="audioFile" type="file" accept="audio/*"/>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="playFile" disabled>Play file</button>
        <button class="btn" id="stopFile" disabled>Stop file</button>
      </div>

      <div class="divider"></div>
      <h2>Teacher mode</h2>
      <div class="muted small">Add your own excerpt (stored offline in this browser).</div>
      <div class="col" style="margin-top:8px">
        <input id="customTitle" type="text" placeholder="Custom title (e.g., 'Trifles — excerpt')"/>
        <textarea id="customBody" placeholder="Paste excerpt here (short is better)."></textarea>
        <div class="row">
          <button class="btn" id="saveCustom">Save</button>
          <button class="btn danger" id="resetAll">Reset ALL</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Preview</h2>
      <div class="row">
        <span class="pill">Words: <span id="wCount">0</span></span>
        <span class="pill">Focus: <span id="focus">—</span></span>
        <span class="pill">Level: <span id="level">—</span></span>
      </div>
      <div class="divider"></div>
      <div id="preview" class="textbox"></div>
    </div>
  </section>

  <!-- QUIZ -->
  <section id="view-quiz" class="grid hidden">
    <div class="card">
      <h2>Quiz Setup</h2>
      <div class="muted">Short quizzes. Frequent. Device → effect → meaning.</div>
      <div class="divider"></div>
      <label class="small muted">Text</label>
      <select id="quizText"></select>

      <label class="small muted" style="margin-top:10px">Mode</label>
      <select id="quizMode">
        <option value="devices">Devices & techniques</option>
        <option value="meaning">Meaning & inference</option>
        <option value="mixed">Mixed</option>
      </select>

      <label class="small muted" style="margin-top:10px">Questions</label>
      <select id="quizCount">
        <option>5</option><option>8</option><option>10</option>
      </select>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="startQuiz">Start</button>
        <button class="btn" id="backHome1">Home</button>
      </div>

      <div class="divider"></div>
      <div class="row">
        <span class="pill">Best: <span id="bestScore">—</span></span>
        <span class="pill">Attempts: <span id="attempts">0</span></span>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2 id="quizTitle">Quiz</h2>
          <div class="muted" id="quizMeta">—</div>
        </div>
      </div>

      <div id="quizArea" class="col"></div>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="submitQuiz" disabled>Submit</button>
        <button class="btn" id="newQuiz" disabled>New quiz</button>
      </div>
      <div id="quizResult" class="muted" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- FLASHCARDS -->
  <section id="view-cards" class="grid hidden">
    <div class="card">
      <h2>Flashcards</h2>
      <div class="muted">Build decks: terms, devices, character traits, themes, quotes.</div>
      <div class="divider"></div>

      <label class="small muted">Deck</label>
      <select id="deckSelect"></select>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="studyDeck">Study</button>
        <button class="btn" id="shuffleDeck">Shuffle</button>
        <button class="btn" id="backHome2">Home</button>
      </div>

      <div class="divider"></div>
      <h2>Add card</h2>
      <div class="muted small">Keep front short. Back explains + gives one example.</div>
      <div class="col" style="margin-top:8px">
        <input id="cardFront" type="text" placeholder="Front (e.g., 'Metaphor')"/>
        <textarea id="cardBack" placeholder="Back (definition + effect + example)."></textarea>
        <div class="row">
          <button class="btn" id="addCard">Add</button>
          <button class="btn danger" id="clearDeck">Clear deck</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2 id="deckTitle">Study</h2>
          <div class="muted" id="deckMeta">—</div>
        </div>
        <div class="row">
          <span class="pill">Correct: <span id="fcGood">0</span></span>
          <span class="pill">Missed: <span id="fcBad">0</span></span>
        </div>
      </div>

      <div class="divider"></div>
      <div id="flashFace" class="cardFace">
        Pick a deck and click “Study”.
        <div class="flipHint">Click to flip</div>
      </div>

      <div class="row" style="margin-top:12px; justify-content:center">
        <button class="btn" id="prevCard" disabled>Prev</button>
        <button class="btn primary" id="flipCard" disabled>Flip</button>
        <button class="btn" id="nextCard" disabled>Next</button>
      </div>

      <div class="row" style="margin-top:10px; justify-content:center">
        <button class="btn" id="markGood" disabled>I knew it</button>
        <button class="btn" id="markBad" disabled>I missed it</button>
      </div>

      <div class="muted small" style="margin-top:10px">
        This is intentionally simple: no “spaced repetition algorithm theatre”. If you want SR, add it later.
      </div>
    </div>
  </section>

  <!-- MIND MAP -->
  <section id="view-map" class="grid hidden">
    <div class="card">
      <h2>Mind Map</h2>
      <div class="muted">
        Drag nodes. Double-click canvas to add. Shift+click two nodes to link.
      </div>
      <div class="divider"></div>

      <div class="row">
        <button class="btn primary" id="newMap">New map</button>
        <button class="btn" id="exportMap">Export JSON</button>
        <button class="btn" id="importMapBtn">Import JSON</button>
        <button class="btn" id="backHome3">Home</button>
      </div>

      <div class="divider"></div>
      <h2>Selected node</h2>
      <div class="muted small">Rename it, or delete it.</div>
      <div class="col" style="margin-top:8px">
        <input id="nodeLabel" type="text" placeholder="Node label" disabled/>
        <div class="row">
          <button class="btn" id="saveNode" disabled>Save</button>
          <button class="btn danger" id="delNode" disabled>Delete</button>
        </div>
      </div>

      <div class="divider"></div>
      <div class="muted small">
        Use this to map: <b>theme</b> → <b>evidence</b> → <b>device</b> → <b>effect</b>.
        Most students fail because they skip the “evidence” node.
      </div>

      <input id="importMapFile" type="file" accept="application/json" class="hidden"/>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2 id="mapTitle">Map</h2>
          <div class="muted" id="mapMeta">—</div>
        </div>
        <div class="row">
          <span class="pill">Nodes: <span id="nodeCount">0</span></span>
          <span class="pill">Links: <span id="linkCount">0</span></span>
        </div>
      </div>
      <div class="divider"></div>
      <canvas id="mapCanvas"></canvas>
      <div class="muted small" style="margin-top:8px">
        Controls: Drag node • Double-click canvas add node • Shift+click 2 nodes link • Right-click node delete link-mode selection
      </div>
    </div>
  </section>
</main>

<script>
/* =======================
   OFFLINE STATE (localStorage)
======================= */
const LS = "litgarden.v1";
const nowISO = () => new Date().toISOString();
const uid = () => Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);

function loadState(){
  const raw = localStorage.getItem(LS);
  if(!raw) return null;
  try { return JSON.parse(raw); } catch { return null; }
}
function saveState(){ localStorage.setItem(LS, JSON.stringify(state)); }
function wordCount(s){ return (s.trim().match(/\S+/g) || []).length; }

function seedTexts(){
  return [
    { id:"pp1", title:"Pride and Prejudice — Opening (excerpt)", focus:"Irony + social norms", level:"Intermediate",
      body:`It is a truth universally acknowledged, that a single man in possession of a good fortune, must be in want of a wife.

“My dear Mr. Bennet,” said his lady to him one day, “have you heard that Netherfield Park is let at last?”

Mr. Bennet replied that he had not.` },
    { id:"pp2", title:"Pride and Prejudice — 'Tolerable' (excerpt)", focus:"Tone + power in dialogue", level:"Intermediate",
      body:`“She is tolerable; but not handsome enough to tempt me; I am in no humour at present to give consequence to young ladies...”` },
    { id:"winter", title:"Winter Song — Shakespeare (excerpt)", focus:"Sound + imagery", level:"Beginner→Intermediate",
      body:`When icicles hang by the wall,
And Dick the shepherd blows his nail,
And Tom bears logs into the hall,
And milk comes frozen home in pail,
When blood is nipp’d and ways be foul,
Then nightly sings the staring owl,
Tu-whit;
Tu-who, a merry note,
While greasy Joan doth keel the pot.` },
    { id:"harlem", title:"Harlem — Langston Hughes (short excerpt)", focus:"Imagery + inference", level:"Beginner",
      body:`What happens to a dream deferred?
Does it dry up
like a raisin in the sun?
Or fester like a sore—
And then run?` },
  ];
}

function seedDecks(){
  return [
    { id:"terms", title:"Core Literary Terms", cards:[
      {id:uid(), front:"Metaphor", back:"A direct comparison (A is B). Effect: compresses meaning, adds implication. Example: “Time is a thief.”"},
      {id:uid(), front:"Irony", back:"Meaning differs from literal words. Effect: critique, humor, distance. Ask: who sees the gap?"},
      {id:uid(), front:"Imagery", back:"Sensory language (sight/sound/touch/etc.). Effect: mood + concreteness + theme support."},
      {id:uid(), front:"Tone", back:"Speaker’s attitude. Prove it with diction/syntax. Don’t guess feelings without evidence."},
      {id:uid(), front:"Theme", back:"Central idea argued by the text. Not one word. It’s a claim (e.g., “Pride distorts judgment”)."},
    ]},
    { id:"pp", title:"Pride & Prejudice — Quick Cards", cards:[
      {id:uid(), front:"Opening sentence: why memorable?", back:"It sounds universal and factual — but it’s satirical. It exposes social assumptions about marriage/wealth."},
      {id:uid(), front:"Darcy: “tolerable” reveals…", back:"Dismissive judgment; social ranking; power. Effect: sets conflict + character arc."},
    ]},
  ];
}

function seedMap(){
  // Minimal starter map template
  return {
    nodes:[
      {id:uid(), x:260, y:180, label:"Theme"},
      {id:uid(), x:520, y:120, label:"Evidence (quote)"},
      {id:uid(), x:520, y:260, label:"Device"},
      {id:uid(), x:780, y:190, label:"Effect / Meaning"},
    ],
    links:[]
  };
}

function freshState(){
  return {
    texts: seedTexts(),
    decks: seedDecks(),
    quiz: { bestScore:null, attempts:0, history:[] },
    map: seedMap(),
    lastTextId: "pp1",
    audio: { volume: 0.35 }
  };
}

let state = loadState() || freshState();
saveState();

/* =======================
   TABS / ROUTING
======================= */
const tabs = [
  {id:"home", label:"Home"},
  {id:"quiz", label:"Quizzes"},
  {id:"cards", label:"Flashcards"},
  {id:"map", label:"Mind Map"},
];

const tabsEl = document.getElementById("tabs");
let view = "home";

function showView(id){
  for(const t of tabs){
    document.getElementById("view-"+t.id).classList.toggle("hidden", t.id!==id);
    document.querySelector(`[data-tab="${t.id}"]`).classList.toggle("active", t.id===id);
  }
  view = id;
  if(id==="map") resizeCanvas();
}

function mountTabs(){
  tabsEl.innerHTML="";
  tabs.forEach(t=>{
    const b=document.createElement("button");
    b.className="tab";
    b.textContent=t.label;
    b.dataset.tab=t.id;
    b.addEventListener("click", ()=>showView(t.id));
    tabsEl.appendChild(b);
  });
}

/* =======================
   HOME (Library + Audio + custom text)
======================= */
const textSelect = document.getElementById("textSelect");
const quizText = document.getElementById("quizText");
const preview = document.getElementById("preview");
const wCount = document.getElementById("wCount");
const focus = document.getElementById("focus");
const level = document.getElementById("level");

function refreshTextMenus(){
  textSelect.innerHTML="";
  quizText.innerHTML="";
  state.texts.forEach(tx=>{
    textSelect.add(new Option(tx.title, tx.id));
    quizText.add(new Option(tx.title, tx.id));
  });
  const last = state.lastTextId || state.texts[0]?.id;
  if(last){
    textSelect.value = last;
    quizText.value = last;
  }
  renderPreview();
}
function getText(id){ return state.texts.find(t=>t.id===id); }

function renderPreview(){
  const tx = getText(textSelect.value);
  state.lastTextId = tx.id;
  saveState();
  preview.textContent = tx.body;
  wCount.textContent = wordCount(tx.body);
  focus.textContent = tx.focus || "—";
  level.textContent = tx.level || "—";
}
textSelect.addEventListener("change", renderPreview);

document.getElementById("saveCustom").addEventListener("click", ()=>{
  const title = document.getElementById("customTitle").value.trim();
  const body = document.getElementById("customBody").value.trim();
  if(!title || !body){ alert("Title + excerpt required."); return; }
  state.texts.unshift({ id:"custom-"+uid(), title, focus:"—", level:"Teacher-defined", body });
  document.getElementById("customTitle").value="";
  document.getElementById("customBody").value="";
  saveState();
  refreshTextMenus();
});

document.getElementById("resetAll").addEventListener("click", ()=>{
  if(!confirm("Reset ALL data on this device?")) return;
  state = freshState();
  saveState();
  refreshTextMenus();
  refreshDeckMenu();
  alert("Reset done.");
});

/* Quick nav buttons */
document.getElementById("goQuiz").addEventListener("click", ()=>showView("quiz"));
document.getElementById("goCards").addEventListener("click", ()=>showView("cards"));
document.getElementById("goMap").addEventListener("click", ()=>showView("map"));
document.getElementById("backHome1").addEventListener("click", ()=>showView("home"));
document.getElementById("backHome2").addEventListener("click", ()=>showView("home"));
document.getElementById("backHome3").addEventListener("click", ()=>showView("home"));

/* =======================
   QUIZZES
======================= */
const QUESTION_BANK = [
  // Devices
  {mode:"devices", textId:"winter",
   q:"In “Tu-whit; Tu-who”, what device is strongest?",
   options:["Onomatopoeia (sound imitation)","Simile","Hyperbole","Allegory"], a:0,
   why:"It mimics the owl’s call, building sound imagery and atmosphere."},
  {mode:"devices", textId:"pp1",
   q:"The opening “It is a truth universally acknowledged…” is best read as…",
   options:["Ironic / satirical","A scientific fact","A legal claim","A personal confession"], a:0,
   why:"The grand tone exposes social assumptions about marriage and wealth."},
  {mode:"devices", textId:"pp2",
   q:"Darcy’s “tolerable” line mainly reveals…",
   options:["Dismissive tone + social superiority","Hidden love","Neutral description","Pure comedy only"], a:0,
   why:"It signals judgement, ranking, and power in the room."},

  // Meaning / inference
  {mode:"meaning", textId:"harlem",
   q:"The poem’s chain of questions mainly forces the reader to…",
   options:["Infer consequences and pressure","Assume the dream succeeds","Ignore emotion","Focus on setting only"], a:0,
   why:"Questions build tension and invite implied outcomes."},
  {mode:"meaning", textId:"winter",
   q:"The repeated “When…” structure suggests…",
   options:["Accumulation of harsh conditions","A sudden plot twist","A flashback to summer","A private confession"], a:0,
   why:"It stacks winter images to intensify mood."},
  {mode:"meaning", textId:"pp1",
   q:"In the dialogue, Mrs. Bennet’s urgency mainly implies…",
   options:["Status anxiety and marriage-as-security thinking","Indifference to society","Fear of travel","Academic curiosity"], a:0,
   why:"Her focus is social opportunity, not the park itself."},
];

const quizArea = document.getElementById("quizArea");
const quizTitle = document.getElementById("quizTitle");
const quizMeta = document.getElementById("quizMeta");
const submitQuiz = document.getElementById("submitQuiz");
const newQuiz = document.getElementById("newQuiz");
const quizResult = document.getElementById("quizResult");
const bestScoreEl = document.getElementById("bestScore");
const attemptsEl = document.getElementById("attempts");

let activeQuiz = null;

function quizStats(){
  attemptsEl.textContent = state.quiz.attempts || 0;
  bestScoreEl.textContent = state.quiz.bestScore==null ? "—" : state.quiz.bestScore + "%";
}

function pickQuestions(textId, mode, count){
  const pool = QUESTION_BANK.filter(x=>{
    if(mode==="mixed") return x.textId===textId;
    return x.textId===textId && x.mode===mode;
  });
  const pool2 = pool.length>=count ? pool : QUESTION_BANK.filter(x=>x.textId===textId);
  const shuffled=[...pool2].sort(()=>Math.random()-0.5);
  return shuffled.slice(0, count);
}

document.getElementById("startQuiz").addEventListener("click", ()=>{
  const textId = quizText.value;
  const mode = document.getElementById("quizMode").value;
  const count = parseInt(document.getElementById("quizCount").value,10);
  const tx = getText(textId);
  const qs = pickQuestions(textId, mode, count);
  if(qs.length===0){ alert("No questions for this text yet."); return; }

  activeQuiz = { textId, mode, qs, answers:{} };
  quizTitle.textContent = "Quiz — " + tx.title;
  quizMeta.textContent = `Mode: ${mode} • Questions: ${qs.length}`;
  quizArea.innerHTML = "";
  quizResult.textContent = "";
  submitQuiz.disabled = false;
  newQuiz.disabled = true;

  qs.forEach((qq,i)=>{
    const box=document.createElement("div");
    box.className="q";
    box.innerHTML = `<h3>Q${i+1}. ${escape(qq.q)}</h3>`;
    qq.options.forEach((opt,idx)=>{
      const line=document.createElement("label");
      line.className="opt";
      line.innerHTML = `<input type="radio" name="q${i}" value="${idx}"> <span>${escape(opt)}</span>`;
      line.querySelector("input").addEventListener("change",(e)=>{
        activeQuiz.answers[i]=parseInt(e.target.value,10);
      });
      box.appendChild(line);
    });
    quizArea.appendChild(box);
  });
});

submitQuiz.addEventListener("click", ()=>{
  if(!activeQuiz) return;
  const {qs, answers, textId} = activeQuiz;

  if(Object.keys(answers).length < qs.length){
    if(!confirm("Some questions unanswered. Submit anyway?")) return;
  }

  let correct=0;
  const blocks = quizArea.querySelectorAll(".q");
  blocks.forEach((b,i)=>{
    const picked = answers[i];
    const right = qs[i].a;
    const isRight = picked===right;
    if(isRight) correct++;

    const tag=document.createElement("div");
    tag.className="row";
    tag.style.justifyContent="space-between";
    tag.style.marginTop="8px";
    tag.innerHTML = `
      <span class="badge ${isRight?"good":"bad"}">${isRight?"Correct":"Wrong"}</span>
      <span class="muted small">${escape(qs[i].why)}</span>
    `;
    b.appendChild(tag);
  });

  const score = Math.round((correct/qs.length)*100);
  state.quiz.attempts = (state.quiz.attempts||0)+1;
  state.quiz.bestScore = state.quiz.bestScore==null ? score : Math.max(state.quiz.bestScore, score);
  state.quiz.history.unshift({at: nowISO(), score, textId, mode: activeQuiz.mode});
  state.quiz.history = state.quiz.history.slice(0, 30);
  saveState();

  quizStats();
  quizResult.innerHTML = `<b class="${score>=70?"good":score>=50?"warn":"bad"}">Score: ${score}%</b> — ${correct}/${qs.length} correct`;
  submitQuiz.disabled=true;
  newQuiz.disabled=false;
});

newQuiz.addEventListener("click", ()=>document.getElementById("startQuiz").click());

/* =======================
   FLASHCARDS
======================= */
const deckSelect = document.getElementById("deckSelect");
const deckTitle = document.getElementById("deckTitle");
const deckMeta = document.getElementById("deckMeta");
const flashFace = document.getElementById("flashFace");
const fcGood = document.getElementById("fcGood");
const fcBad = document.getElementById("fcBad");

let study = { deckId:null, order:[], idx:0, flipped:false, good:0, bad:0 };

function refreshDeckMenu(){
  deckSelect.innerHTML="";
  state.decks.forEach(d=> deckSelect.add(new Option(d.title, d.id)));
  if(!state.decks.length){
    state.decks = seedDecks();
    saveState();
    refreshDeckMenu();
  }
}
function getDeck(id){ return state.decks.find(d=>d.id===id); }

document.getElementById("addCard").addEventListener("click", ()=>{
  const deck = getDeck(deckSelect.value);
  const front = document.getElementById("cardFront").value.trim();
  const back = document.getElementById("cardBack").value.trim();
  if(!front || !back){ alert("Front + back required."); return; }
  deck.cards.unshift({id:uid(), front, back});
  document.getElementById("cardFront").value="";
  document.getElementById("cardBack").value="";
  saveState();
  alert("Added.");
});

document.getElementById("clearDeck").addEventListener("click", ()=>{
  const deck = getDeck(deckSelect.value);
  if(!confirm(`Clear deck "${deck.title}"?`)) return;
  deck.cards = [];
  saveState();
  stopStudy("Deck cleared.");
});

document.getElementById("shuffleDeck").addEventListener("click", ()=>{
  if(!study.deckId){ alert("Start study first."); return; }
  study.order.sort(()=>Math.random()-0.5);
  study.idx = 0;
  study.flipped = false;
  renderFlash();
});

document.getElementById("studyDeck").addEventListener("click", ()=>{
  const deck = getDeck(deckSelect.value);
  if(!deck.cards.length){
    alert("Deck is empty. Add cards first.");
    return;
  }
  study.deckId = deck.id;
  study.order = deck.cards.map(c=>c.id).sort(()=>Math.random()-0.5);
  study.idx = 0;
  study.flipped = false;
  study.good = 0;
  study.bad = 0;
  enableFlash(true);
  renderFlash();
});

function enableFlash(on){
  document.getElementById("prevCard").disabled = !on;
  document.getElementById("flipCard").disabled = !on;
  document.getElementById("nextCard").disabled = !on;
  document.getElementById("markGood").disabled = !on;
  document.getElementById("markBad").disabled = !on;
}

function currentCard(){
  const deck = getDeck(study.deckId);
  const id = study.order[study.idx];
  return deck.cards.find(c=>c.id===id);
}

function renderFlash(){
  const deck = getDeck(study.deckId);
  deckTitle.textContent = "Study — " + deck.title;
  deckMeta.textContent = `${deck.cards.length} cards • Card ${study.idx+1}/${study.order.length}`;
  fcGood.textContent = study.good;
  fcBad.textContent = study.bad;

  const c = currentCard();
  study.flipped = !!study.flipped;
  flashFace.innerHTML = `${escape(study.flipped ? c.back : c.front)}<div class="flipHint">Click to flip</div>`;
}

function stopStudy(msg){
  study = { deckId:null, order:[], idx:0, flipped:false, good:0, bad:0 };
  enableFlash(false);
  deckTitle.textContent="Study";
  deckMeta.textContent="—";
  fcGood.textContent="0"; fcBad.textContent="0";
  flashFace.innerHTML = `${escape(msg)}<div class="flipHint">Click to flip</div>`;
}

flashFace.addEventListener("click", ()=>{
  if(!study.deckId) return;
  study.flipped = !study.flipped;
  renderFlash();
});
document.getElementById("flipCard").addEventListener("click", ()=>flashFace.click());

document.getElementById("prevCard").addEventListener("click", ()=>{
  if(!study.deckId) return;
  study.idx = Math.max(0, study.idx-1);
  study.flipped = false;
  renderFlash();
});
document.getElementById("nextCard").addEventListener("click", ()=>{
  if(!study.deckId) return;
  study.idx = Math.min(study.order.length-1, study.idx+1);
  study.flipped = false;
  renderFlash();
});
document.getElementById("markGood").addEventListener("click", ()=>{
  if(!study.deckId) return;
  study.good++;
  if(study.idx < study.order.length-1) study.idx++;
  study.flipped = false;
  renderFlash();
});
document.getElementById("markBad").addEventListener("click", ()=>{
  if(!study.deckId) return;
  study.bad++;
  if(study.idx < study.order.length-1) study.idx++;
  study.flipped = false;
  renderFlash();
});

/* =======================
   MIND MAP (Canvas)
======================= */
const canvas = document.getElementById("mapCanvas");
const ctx = canvas.getContext("2d");
const nodeLabel = document.getElementById("nodeLabel");
const saveNodeBtn = document.getElementById("saveNode");
const delNodeBtn = document.getElementById("delNode");
const nodeCount = document.getElementById("nodeCount");
const linkCount = document.getElementById("linkCount");
const mapTitle = document.getElementById("mapTitle");
const mapMeta = document.getElementById("mapMeta");

let map = state.map || seedMap();
let drag = { active:false, nodeId:null, dx:0, dy:0 };
let selectedNodeId = null;
let linkPick = null; // for shift+click linking

function resizeCanvas(){
  const rect = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  canvas.width = Math.floor(rect.width * dpr);
  canvas.height = Math.floor(rect.height * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  drawMap();
}
window.addEventListener("resize", ()=>{ if(view==="map") resizeCanvas(); });

function saveMap(){
  state.map = map;
  saveState();
}

function nodeAt(x,y){
  // hit test: radius 26
  for(let i=map.nodes.length-1; i>=0; i--){
    const n = map.nodes[i];
    const dx = x - n.x, dy = y - n.y;
    if(Math.hypot(dx,dy) <= 26) return n;
  }
  return null;
}

function drawMap(){
  const rect = canvas.getBoundingClientRect();
  ctx.clearRect(0,0,rect.width,rect.height);

  // links
  ctx.lineWidth = 2;
  ctx.strokeStyle = "rgba(255,255,255,.28)";
  map.links.forEach(l=>{
    const a = map.nodes.find(n=>n.id===l.a);
    const b = map.nodes.find(n=>n.id===l.b);
    if(!a||!b) return;
    ctx.beginPath();
    ctx.moveTo(a.x,a.y);
    ctx.lineTo(b.x,b.y);
    ctx.stroke();
  });

  // nodes
  map.nodes.forEach(n=>{
    const isSel = n.id===selectedNodeId;
    const isPick = n.id===linkPick;

    // glow
    ctx.beginPath();
    ctx.arc(n.x,n.y,28,0,Math.PI*2);
    ctx.fillStyle = isSel ? "rgba(167,243,208,.16)" : isPick ? "rgba(251,207,232,.14)" : "rgba(255,255,255,.08)";
    ctx.fill();

    // core
    ctx.beginPath();
    ctx.arc(n.x,n.y,22,0,Math.PI*2);
    ctx.fillStyle = isSel ? "rgba(167,243,208,.22)" : "rgba(0,0,0,.18)";
    ctx.fill();
    ctx.strokeStyle = isSel ? "rgba(167,243,208,.55)" : "rgba(255,255,255,.24)";
    ctx.lineWidth = 2;
    ctx.stroke();

    // label
    ctx.fillStyle = "rgba(238,242,255,.95)";
    ctx.font = "600 12.5px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    const label = n.label.length>24 ? (n.label.slice(0,24)+"…") : n.label;
    ctx.fillText(label, n.x, n.y);
  });

  nodeCount.textContent = map.nodes.length;
  linkCount.textContent = map.links.length;
  mapTitle.textContent = "Map";
  mapMeta.textContent = "Double-click to add • Shift+click to link • Drag to move";
}

function setSelected(id){
  selectedNodeId = id;
  const n = map.nodes.find(x=>x.id===id);
  const has = !!n;
  nodeLabel.disabled = !has;
  saveNodeBtn.disabled = !has;
  delNodeBtn.disabled = !has;
  if(has) nodeLabel.value = n.label;
  drawMap();
}

function addNode(x,y,label="New idea"){
  const n = {id:uid(), x, y, label};
  map.nodes.push(n);
  saveMap();
  setSelected(n.id);
}

function toggleLink(a,b){
  if(a===b) return;
  const key = (x,y)=> x+"|"+y;
  const existsIndex = map.links.findIndex(l=>{
    return (l.a===a && l.b===b) || (l.a===b && l.b===a);
  });
  if(existsIndex>=0){
    map.links.splice(existsIndex,1);
  }else{
    map.links.push({a,b});
  }
  saveMap();
  drawMap();
}

function deleteNode(id){
  map.nodes = map.nodes.filter(n=>n.id!==id);
  map.links = map.links.filter(l=>l.a!==id && l.b!==id);
  saveMap();
  setSelected(null);
}

function pointerPos(e){
  const r = canvas.getBoundingClientRect();
  const x = (e.clientX - r.left);
  const y = (e.clientY - r.top);
  return {x,y};
}

canvas.addEventListener("pointerdown", (e)=>{
  canvas.setPointerCapture(e.pointerId);
  const {x,y} = pointerPos(e);
  const n = nodeAt(x,y);
  if(n){
    if(e.shiftKey){
      if(linkPick && linkPick!==n.id){
        toggleLink(linkPick, n.id);
        linkPick = null;
      }else{
        linkPick = n.id;
      }
      setSelected(n.id);
      drawMap();
      return;
    }
    setSelected(n.id);
    drag.active = true;
    drag.nodeId = n.id;
    drag.dx = x - n.x;
    drag.dy = y - n.y;
  }else{
    setSelected(null);
    linkPick = null;
  }
});

canvas.addEventListener("pointermove", (e)=>{
  if(!drag.active) return;
  const {x,y} = pointerPos(e);
  const n = map.nodes.find(n=>n.id===drag.nodeId);
  if(!n) return;
  n.x = x - drag.dx;
  n.y = y - drag.dy;
  drawMap();
});

canvas.addEventListener("pointerup", ()=>{
  if(drag.active){
    drag.active=false;
    drag.nodeId=null;
    saveMap();
  }
});

canvas.addEventListener("dblclick", (e)=>{
  const {x,y} = pointerPos(e);
  addNode(x,y,"New node");
});

document.getElementById("saveNode").addEventListener("click", ()=>{
  const n = map.nodes.find(n=>n.id===selectedNodeId);
  if(!n) return;
  n.label = nodeLabel.value.trim() || "Untitled";
  saveMap();
  drawMap();
});

document.getElementById("delNode").addEventListener("click", ()=>{
  if(!selectedNodeId) return;
  if(!confirm("Delete this node?")) return;
  deleteNode(selectedNodeId);
});

document.getElementById("newMap").addEventListener("click", ()=>{
  if(!confirm("Start a new blank map?")) return;
  map = {nodes:[], links:[]};
  saveMap();
  setSelected(null);
  drawMap();
});

document.getElementById("exportMap").addEventListener("click", ()=>{
  const data = { exportedAt: nowISO(), map };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "LitGarden_MindMap.json";
  a.click();
  URL.revokeObjectURL(a.href);
});

const importFile = document.getElementById("importMapFile");
document.getElementById("importMapBtn").addEventListener("click", ()=>importFile.click());
importFile.addEventListener("change", async ()=>{
  const file = importFile.files?.[0];
  if(!file) return;
  try{
    const txt = await file.text();
    const obj = JSON.parse(txt);
    if(!obj.map || !obj.map.nodes || !obj.map.links) throw new Error("Bad format");
    map = obj.map;
    saveMap();
    setSelected(null);
    drawMap();
    alert("Imported.");
  }catch{
    alert("Import failed. Must be a LitGarden mind map JSON.");
  }finally{
    importFile.value="";
  }
});

/* =======================
   AUDIO (safe offline)
   - Ambient generator via WebAudio (no copyright)
   - Optional local audio file playback
======================= */
let audioCtx = null;
let master = null;
let ambienceOn = false;
let fileAudio = new Audio();
fileAudio.loop = true;

const vol = document.getElementById("vol");
vol.value = state.audio.volume ?? 0.35;

function setVolume(v){
  const value = Math.max(0, Math.min(1, v));
  state.audio.volume = value;
  saveState();
  if(master) master.gain.value = value;
  fileAudio.volume = value;
}
vol.addEventListener("input", (e)=> setVolume(parseFloat(e.target.value)));

function createAmbience(){
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  master = audioCtx.createGain();
  master.gain.value = state.audio.volume ?? 0.35;
  master.connect(audioCtx.destination);

  // Soft pad: 3 sine oscillators + slow LFO + gentle filter + reverb-ish delay
  const filter = audioCtx.createBiquadFilter();
  filter.type = "lowpass";
  filter.frequency.value = 800;
  filter.Q.value = 0.7;

  const delay = audioCtx.createDelay(2.0);
  delay.delayTime.value = 0.22;

  const fb = audioCtx.createGain();
  fb.gain.value = 0.18;

  delay.connect(fb);
  fb.connect(delay);

  filter.connect(delay);
  delay.connect(master);
  filter.connect(master);

  const lfo = audioCtx.createOscillator();
  lfo.type = "sine";
  lfo.frequency.value = 0.07; // very slow

  const lfoGain = audioCtx.createGain();
  lfoGain.gain.value = 110; // mod filter freq
  lfo.connect(lfoGain);
  lfoGain.connect(filter.frequency);

  // chord-ish frequencies (A minor-ish feel): A3, C4, E4
  const freqs = [220, 261.63, 329.63];
  const oscs = freqs.map((f,i)=>{
    const o = audioCtx.createOscillator();
    o.type = "sine";
    o.frequency.value = f;
    const g = audioCtx.createGain();
    g.gain.value = 0.10 - i*0.02;
    o.connect(g);
    g.connect(filter);
    return o;
  });

  // subtle noise for “air”
  const noiseBuf = audioCtx.createBuffer(1, audioCtx.sampleRate*2, audioCtx.sampleRate);
  const data = noiseBuf.getChannelData(0);
  for(let i=0;i<data.length;i++) data[i] = (Math.random()*2-1) * 0.18;
  const noise = audioCtx.createBufferSource();
  noise.buffer = noiseBuf;
  noise.loop = true;
  const noiseFilter = audioCtx.createBiquadFilter();
  noiseFilter.type = "highpass";
  noiseFilter.frequency.value = 180;
  const noiseGain = audioCtx.createGain();
  noiseGain.gain.value = 0.05;
  noise.connect(noiseFilter);
  noiseFilter.connect(noiseGain);
  noiseGain.connect(master);

  lfo.start();
  oscs.forEach(o=>o.start());
  noise.start();

  return { oscs, lfo, noise, filter, delay, fb, master };
}

let ambienceGraph = null;
const audioToggle = document.getElementById("audioToggle");

audioToggle.addEventListener("click", async ()=>{
  if(!ambienceOn){
    if(!audioCtx){
      ambienceGraph = createAmbience();
      setVolume(state.audio.volume ?? 0.35);
    }
    await audioCtx.resume();
    ambienceOn = true;
    audioToggle.textContent = "Stop ambience";
  }else{
    // suspend to stop
    if(audioCtx) await audioCtx.suspend();
    ambienceOn = false;
    audioToggle.textContent = "Start ambience";
  }
});

const audioFile = document.getElementById("audioFile");
const playFile = document.getElementById("playFile");
const stopFile = document.getElementById("stopFile");
let fileURL = null;

audioFile.addEventListener("change", ()=>{
  const f = audioFile.files?.[0];
  if(!f) return;
  if(fileURL) URL.revokeObjectURL(fileURL);
  fileURL = URL.createObjectURL(f);
  fileAudio.src = fileURL;
  fileAudio.volume = state.audio.volume ?? 0.35;
  playFile.disabled = false;
  stopFile.disabled = false;
});

playFile.addEventListener("click", async ()=>{
  try{
    // stop ambience to avoid stacking (optional)
    if(ambienceOn && audioCtx) { await audioCtx.suspend(); ambienceOn=false; audioToggle.textContent="Start ambience"; }
    await fileAudio.play();
  }catch{
    alert("Browser blocked autoplay. Click again, or interact with the page first.");
  }
});
stopFile.addEventListener("click", ()=> fileAudio.pause());

/* =======================
   UTIL
======================= */
function escape(s){
  return (s??"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =======================
   INIT
======================= */
mountTabs();
refreshTextMenus();
refreshDeckMenu();
quizStats();
setVolume(state.audio.volume ?? 0.35);
showView("home");
</script>
</body>
</html>

